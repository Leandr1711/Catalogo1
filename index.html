<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Produtos - bringIT System</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAHp6za_KGlDvUEL4GnMLUK5llOgCOdMMk",
      authDomain: "produtos-a5d81.firebaseapp.com",
      projectId: "produtos-a5d81",
      storageBucket: "produtos-a5d81.firebasestorage.app",
      messagingSenderId: "841903119824",
      appId: "1:841903119824:web:48cefee322161840eb2dd5",
      measurementId: "G-YBH3SGYPC8"
    };

    try {
      firebase.initializeApp(firebaseConfig);
      window._firebaseAuth = firebase.auth();
      window._firebaseFirestore = firebase.firestore();
      console.log("✅ Firebase v8 + Firestore inicializado");
    } catch (err) {
      console.error("Erro ao inicializar Firebase:", err);
    }
  </script>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .modal-scroll::-webkit-scrollbar { width: 8px; }
    .modal-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
    .modal-scroll::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
    .modal-scroll::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel" data-presets="typescript,react">
    const { useState, useEffect, useCallback, useMemo } = React;

    const auth = window._firebaseAuth;
    const firestore = window._firebaseFirestore;

    // --- LISTA MESTRA DE ORDEM DAS ESPECIFICAÇÕES ---
    const ORDEM_ESPECS = [
      "sku",
      "marca",
      "tipo",
      "voltagem",
      "capacidade",
      "celulas",
      "wh",
      "amperagem",
      "potencia",
      "cor",
      "idioma",
      "moldura",
      "backlight",
      "tamanho",
      "resolucao",
      "iluminacao",
      "conector",
      "fixacao",
      "pn",
      "tipo de conector",
      "posicaodoconector",
      "largura",
      "tecnologia",
      "touchscreen",
      "frequencia hz",
      "pcb",
      "acabamento"
    ];

    const Category = {
      SCREEN: 'Tela',
      BATTERY: 'Bateria',
      KEYBOARD: 'Teclado',
      POWER_SUPPLY: 'Fonte'
    };

    const FILTERS_CONFIG = {
        [Category.SCREEN]: ['sku','marca','tamanho', 'resolucao', 'iluminacao', 'fixacao', 'acabamento','tipo de conector','posicaodoconector','largura','tecnologia','touchscreen', 'frequencia hz', 'pcb'],
        [Category.BATTERY]: ['voltagem', 'capacidade', 'cor', 'tipo'],
        [Category.KEYBOARD]: ['cor', 'idioma', 'moldura', 'backlight', 'marca'],
        [Category.POWER_SUPPLY]: ['voltagem', 'amperagem', 'potencia', 'conector']
    };

    // --- SERVIDOR ---
    const Server = {
      login: async (email, password) => {
        if (!auth) return null;
        try {
          const userCred = await auth.signInWithEmailAndPassword(email, password);
          const token = await userCred.user.getIdToken();
          return { token, uid: userCred.user.uid };
        } catch (e) {
          console.warn("Falha no signIn:", e);
          return null;
        }
      },
      getProducts: async () => {
        if (!firestore) return [];
        try {
          const categorias = Object.values(Category);
          const all = [];
          for (const cat of categorias) {
            const colRef = firestore.collection('categorias').doc(cat).collection('produtos');
            const snap = await colRef.get();
            snap.forEach(doc => {
              const data = doc.data();
              all.push({
                id: doc.id,
                ...data,
                categoria: cat,
                imagens: Array.isArray(data.imagens) ? data.imagens : (data.imagens ? [data.imagens] : [])
              });
            });
          }
          return all.sort((a,b) => (a.nome || '').localeCompare(b.nome || '', undefined, { numeric: true, sensitivity: 'base' }));
        } catch (e) {
          console.error(e);
          return [];
        }
      },
      addProduct: async (token, product) => {
        if (!firestore) throw new Error("Firestore não inicializado");
        const { id, ...rest } = product;
        const categoria = product.categoria || Category.SCREEN;
        const colRef = firestore.collection('categorias').doc(categoria).collection('produtos');
        const now = firebase.firestore.FieldValue.serverTimestamp();
        const docRef = await colRef.add({ ...rest, criadoEm: now });
        return { id: docRef.id, ...rest, categoria };
      },
      updateProduct: async (token, product) => {
        if (!firestore) throw new Error("Firestore não inicializado");
        const { id, categoria, ...rest } = product;
        if (!id || !categoria) throw new Error("Produto precisa de id e categoria para atualizar");
        const docRef = firestore.collection('categorias').doc(categoria).collection('produtos').doc(id);
        await docRef.set(rest, { merge: true });
        return { id, ...rest, categoria };
      },
      addBatch: async (token, productsArray) => {
        if (!firestore) throw new Error("Firestore não inicializado");
        const batch = firestore.batch();
        let count = 0;
        for (const p of productsArray) {
          const categoria = p.categoria || Category.SCREEN;
          const colRef = firestore.collection('categorias').doc(categoria).collection('produtos');
          const newDocRef = colRef.doc();
          const { id, ...rest } = p;
          batch.set(newDocRef, { ...rest, criadoEm: firebase.firestore.FieldValue.serverTimestamp() });
          count++;
        }
        await batch.commit();
        return count;
      },
      removeProduct: async (token, id, categoria) => {
        if (!firestore) throw new Error("Firestore não inicializado");
        await firestore.collection('categorias').doc(categoria).collection('produtos').doc(id).delete();
        return true;
      }
    };

    // --- UI COMPONENTS ---
    const InputField = ({ label, name, placeholder, required, value, onChange, colSpan = 1 }) => (
      <div className={colSpan > 1 ? `col-span-${colSpan} md:col-span-${colSpan}` : ''}>
        <label className="block text-sm font-semibold text-gray-600 mb-1">{label} {required && <span className="text-red-500">*</span>}</label>
        <input type="text" name={name} value={value || ''} onChange={onChange} placeholder={placeholder} className="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-green-500 focus:border-green-500 placeholder-gray-400 transition-shadow" />
      </div>
    );
    const SelectField = ({ label, name, options, value, onChange }) => (
      <div>
        <label className="block text-sm font-semibold text-gray-600 mb-1">{label}</label>
        <div className="relative">
          <select name={name} value={value || ''} onChange={onChange} className="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-green-500 focus:border-green-500 appearance-none bg-white text-gray-700">
            <option value="">Selecione...</option>{options.map(opt => <option key={opt} value={opt}>{opt}</option>)}
          </select>
          <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500"><svg className="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" /></svg></div>
        </div>
      </div>
    );

    // --- BARRA DE FERRAMENTAS (FILTRO + PAGINAÇÃO) ---
    const FilterBar = ({ 
      category, products, activeFilters, onFilterChange, 
      currentPage, totalPages, itemsPerPage, onItemsPerPageChange, onPageChange, totalItems 
    }) => {
        const fieldsToShow = FILTERS_CONFIG[category] || [];
        
        // Calcular opções de filtro
        const filterOptions = useMemo(() => {
            if (fieldsToShow.length === 0) return {};
            const options = {};
            fieldsToShow.forEach(field => {
                const values = new Set();
                products.forEach(p => {
                    if (p.categoria === category && p.especificacoes && p.especificacoes[field]) {
                        values.add(p.especificacoes[field]);
                    }
                });
                options[field] = Array.from(values).sort();
            });
            return options;
        }, [category, products, fieldsToShow]);

        return (
            <div className="bg-white border border-gray-200 rounded-lg p-4 mb-6 shadow-sm animate-fade-in">
                {/* LINHA SUPERIOR: TÍTULO + PAGINAÇÃO */}
                <div className="flex flex-col md:flex-row justify-between items-center gap-4 mb-3">
                    <div className="flex items-center gap-2 text-gray-700">
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" /></svg>
                        <h3 className="text-sm font-bold uppercase">
                          {category === 'Todos' ? 'Todos os Produtos' : `Filtrar ${category}`}
                        </h3>
                    </div>

                    {/* CONTROLES DE PAGINAÇÃO INTEGRADOS */}
                    <div className="hover:bg-green-50   flex items-center gap-3 bg-gray-50 p-1.5 rounded-lg border border-gray-100">
                        <div className="flex items-center gap-2 text-xs text-gray-600 px-2 border-r border-gray-200">
                            <span>Exibir:</span>
                            <select 
                                value={itemsPerPage} 
                                onChange={(e) => onItemsPerPageChange(Number(e.target.value))} 
                                className="w-12 h-8 bg-transparent font-bold focus:outline-none cursor-pointer"
                            >
                                <option value="10">10</option>
                                <option value="20">20</option>
                                <option value="30">30</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                        <div className="flex items-center gap-2 text-xs">
                            <button 
                                onClick={() => onPageChange(p => Math.max(1, p - 1))} 
                                disabled={currentPage === 1}
                                className={`w-11 h-8 flex items-center justify-center rounded hover:bg-green-200 hover:text-green-900 hover:shadow-sm transition-all ${currentPage === 1 ? 'text-gray-300 cursor-not-allowed' : 'text-gray-600'}`}
                            >
                                &lt;
                            </button>
                            <span className="font-medium text-gray-700">{currentPage} / {totalPages || 1}</span>
                            <button 
                                onClick={() => onPageChange(p => Math.min(totalPages, p + 1))} 
                                disabled={currentPage === totalPages || totalPages === 0}
                                className={`w-11 h-8 flex items-center justify-center rounded hover:bg-green-200 hover:text-green-900 hover:shadow-sm transition-all ${currentPage === totalPages || totalPages === 0 ? 'text-gray-300 cursor-not-allowed' : 'text-gray-600'}`}
                            >
                                &gt;
                            </button>
                        </div>
                    </div>
                </div>

                {/* ÁREA DOS FILTROS (SÓ APARECE SE NÃO FOR "TODOS") */}
                {category !== 'Todos' && fieldsToShow.length > 0 && (
                    <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3 border-t border-gray-100 pt-3 mt-1">
                        {fieldsToShow.map(field => (
                            <div key={field}>
                                <label className="block text-[10px] font-bold text-gray-400 mb-1 capitalize">{field.replace('_', ' ')}</label>
                                <select className="w-full border border-gray-300 rounded text-xs py-1.5 px-2 focus:ring-1 focus:ring-green-500 outline-none bg-gray-50" value={activeFilters[field] || ''} onChange={(e) => onFilterChange(field, e.target.value)}>
                                    <option value="">Todos</option>
                                    {filterOptions[field] && filterOptions[field].map(val => <option key={val} value={val}>{val}</option>)}
                                </select>
                            </div>
                        ))}
                        {Object.keys(activeFilters).some(k => activeFilters[k]) && (
                            <div className="flex items-end">
                                <button onClick={() => { fieldsToShow.forEach(f => onFilterChange(f, '')); }} className="text-xs text-red-500 hover:text-red-700 underline pb-2">Limpar Filtros</button>
                            </div>
                        )}
                    </div>
                )}
            </div>
        );
    };

    // --- MODAIS ---
    const DeleteModal = ({ isOpen, onClose, onConfirm, productName }) => {
        if (!isOpen) return null;
        return (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                <div className="bg-white rounded-lg shadow-xl w-full max-w-sm overflow-hidden" onClick={e => e.stopPropagation()}>
                    <div className="p-6 text-center">
                        <div className="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg className="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </div>
                        <h3 className="text-lg font-bold text-gray-900 mb-2">Excluir Produto?</h3>
                        <p className="text-sm text-gray-500 mb-6">
                            Tem certeza que deseja remover <strong>{productName}</strong>? <br/>Essa ação não pode ser desfeita.
                        </p>
                        <div className="flex gap-3 justify-center">
                            <button onClick={onClose} className="px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50 font-medium text-sm">Cancelar</button>
                            <button onClick={onConfirm} className="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 font-medium text-sm">Sim, Excluir</button>
                        </div>
                    </div>
                </div>
            </div>
        );
    };

    const ImportModal = ({ isOpen, onClose, onImport, notify }) => {
      if (!isOpen) return null;
      const [jsonText, setJsonText] = useState('');
      const [error, setError] = useState('');
      const handleImport = () => {
        try {
          const parsed = JSON.parse(jsonText);
          if (!Array.isArray(parsed)) throw new Error("O formato deve ser uma lista (Array).");
          onImport(parsed); onClose(); setJsonText(''); setError('');
        } catch (e) { setError("Erro no JSON: " + e.message); }
      };
      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm" onClick={onClose}>
          <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl overflow-hidden flex flex-col" onClick={e => e.stopPropagation()}>
            <div className="bg-indigo-600 px-6 py-4 flex justify-between items-center"><h2 className="text-xl font-bold text-white">Importar em Lote</h2><button onClick={onClose} className="text-white hover:text-indigo-200">✕</button></div>
            <div className="p-6">
              <textarea className="w-full h-64 border border-gray-300 rounded p-3 font-mono text-xs focus:ring-2 focus:ring-indigo-500 outline-none" value={jsonText} onChange={e => setJsonText(e.target.value)} placeholder='[{"nome": "...", "categoria":"Tela", "especificacoes": {...}}, ...]' />
              {error && <p className="text-red-500 text-xs mt-2 font-bold">{error}</p>}
            </div>
            <div className="bg-gray-50 px-6 py-4 flex justify-end gap-3"><button onClick={onClose} className="px-4 py-2 text-gray-600 hover:bg-gray-200 rounded">Cancelar</button><button onClick={handleImport} className="px-4 py-2 bg-indigo-600 text-white font-bold rounded hover:bg-indigo-700">Importar</button></div>
          </div>
        </div>
      );
    };

    const ProductModal = ({ product, onClose }) => {
      if (!product) return null;
      const [activeImage, setActiveImage] = useState(product.imagens ? product.imagens[0] : "");
      const [isZoomed, setIsZoomed] = useState(false);
      useEffect(() => { if(product && product.imagens && product.imagens.length > 0) setActiveImage(product.imagens[0]); }, [product]);

      return (
        <>
          <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in" onClick={onClose}>
            <div className="bg-white rounded-lg shadow-2xl w-full max-w-5xl overflow-hidden flex flex-col" onClick={e => e.stopPropagation()}>
              <div className="bg-[#16a34a] px-6 py-4 flex justify-between items-center shrink-0">
                <h2 className="text-xl font-bold text-white">{product.nome}</h2>
                <button onClick={onClose} className="text-white hover:text-green-200 font-bold text-xl">✕</button>
              </div>
              <div className="p-8 overflow-y-auto modal-scroll max-h-[85vh]">
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                  <div className="flex flex-col">
                    <div className="w-full h-96 rounded-lg overflow-hidden border border-gray-200 mb-4 bg-white flex items-center justify-center relative shadow-sm group cursor-zoom-in" onClick={() => setIsZoomed(true)}>
                      {activeImage ? <img src={activeImage} className="w-full h-full object-contain p-2 transition-transform duration-300 group-hover:scale-110" /> : <span className="text-gray-400">Sem imagem</span>}
                    </div>
                    <div className="flex gap-3 mb-6 overflow-x-auto py-2">
                      {product.imagens && product.imagens.map((img, idx) => (
                        <div key={idx} onClick={() => setActiveImage(img)} className={`w-20 h-20 rounded-md overflow-hidden cursor-pointer border-2 transition-all flex-shrink-0 bg-white ${activeImage === img ? 'border-green-500 ring-2 ring-green-100 scale-105' : 'border-gray-200 hover:border-green-300 opacity-80'}`}><img src={img} className="w-full h-full object-contain p-1" /></div>
                      ))}
                    </div>
                    <div className="mt-auto self-start"><span className="bg-gray-100 text-gray-700 px-4 py-1.5 rounded-full text-sm font-semibold border border-gray-200 shadow-sm">{product.categoria}</span></div>
                  </div>
                  <div>
                    <h3 className="text-lg font-bold text-gray-900 mb-3 border-b pb-2">Especificações Técnicas</h3>
                    <div className="rounded-lg border border-gray-100 overflow-hidden text-sm shadow-sm">
                      {product.especificacoes && ORDEM_ESPECS.filter(key => product.especificacoes[key]).map((key, index) => (
                        <div key={key} className={`flex justify-between py-3 px-4 ${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'}`}>
                          <span className="font-bold text-gray-600 capitalize">{key.replace(/_/g, ' ')}:</span>
                          <span className="text-gray-800 text-right ml-4 font-medium">{product.especificacoes[key]}</span>
                        </div>
                      ))}
                      {(!product.especificacoes || Object.keys(product.especificacoes).length === 0) && (
                          <div className="p-4 text-gray-400 text-center italic">Sem especificações cadastradas.</div>
                      )}
                    </div>
                    <div className="mt-6 bg-blue-50 p-4 rounded-lg border border-blue-100"><h4 className="text-blue-800 font-bold text-sm mb-1">Descrição Interna</h4><p className="text-blue-900 text-sm">{product.descricao}</p></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {isZoomed && <div className="fixed inset-0 z-[60] bg-black/95 flex items-center justify-center p-4 animate-fade-in" onClick={() => setIsZoomed(false)}><button onClick={() => setIsZoomed(false)} className="absolute top-5 right-5 text-white text-5xl">&times;</button><img src={activeImage} className="max-w-full max-h-full object-contain" onClick={e => e.stopPropagation()} /></div>}
        </>
      );
    };

    const ProductFormModal = ({ isOpen, onClose, onSave, productToEdit, notify }) => {
      if (!isOpen) return null;
      const [tipoProduto, setTipoProduto] = useState('Tela');
      const [form, setForm] = useState({});

      useEffect(() => {
        if (productToEdit) {
          setTipoProduto(productToEdit.categoria);
          const imgs = productToEdit.imagens || [];
          setForm({ nome: productToEdit.nome, foto1: imgs[0]||'', foto2: imgs[1]||'', foto3: imgs[2]||'', foto4: imgs[3]||'', ...productToEdit.especificacoes });
        } else {
          setTipoProduto('Tela');
          setForm({});
        }
      }, [productToEdit, isOpen]);

      const handleChange = (e) => { const { name, value } = e.target; setForm(prev => ({ ...prev, [name]: value })); };
      const handleTypeChange = (e) => { setTipoProduto(e.target.value); if (!productToEdit) setForm({}); };

      const handleSubmit = async (e) => {
        e.preventDefault();
        const { nome, foto1, foto2, foto3, foto4, plug_imagem, ...specs } = form;
        const mainImage = foto1 || plug_imagem;
        const imagensFinais = [mainImage, foto2, foto3, foto4].filter(img => img && img.trim() !== '');
        if (imagensFinais.length === 0) imagensFinais.push("https://placehold.co/400x300?text=Sem+Imagem");
        
        const productData = {
          id: productToEdit?.id,
          nome: nome || `${tipoProduto} ${form.marca || ''} ${form.modelo || ''}`,
          categoria: tipoProduto,
          descricao: `Produto ${form.marca || ''}. SKU: ${form.sku || 'N/A'}`,
          imagens: imagensFinais,
          especificacoes: specs
        };

        try {
          if (productToEdit && productToEdit.id) {
            await Server.updateProduct(localStorage.getItem('authToken'), productData);
            notify("Produto atualizado com sucesso!", "success");
          } else {
            await Server.addProduct(localStorage.getItem('authToken'), productData);
            notify("Produto cadastrado com sucesso!", "success");
          }
          onSave && onSave(productData);
          onClose();
          setForm({});
        } catch (err) {
          notify("Erro ao salvar: " + err.message, "error");
        }
      };

      const renderFields = () => {
        switch (tipoProduto) {
          case 'Teclado':
            return (
                <>
                    <InputField label="SKU" name="sku" required value={form.sku} onChange={handleChange} />
                    <InputField label="Marca" name="marca" required value={form.marca} onChange={handleChange} />
                    <InputField label="Modelo" name="modelo" value={form.modelo} onChange={handleChange} />
                    <InputField label="Idioma" name="idioma" value={form.idioma} onChange={handleChange} />
                    <InputField label="Cor" name="cor" value={form.cor} onChange={handleChange} />
                    <SelectField label="Moldura" name="moldura" options={['Com Moldura', 'Sem Moldura']} value={form.moldura} onChange={handleChange} />
                    <SelectField label="Backlight" name="backlight" options={['Sim', 'Não']} value={form.backlight} onChange={handleChange} />
                </>
            );
          case 'Bateria':
            return (
                <>
                    <InputField label="SKU" name="sku" required value={form.sku} onChange={handleChange} />
                    <InputField label="Marca" name="marca" required value={form.marca} onChange={handleChange} />
                    <InputField label="Voltagem (V)" name="voltagem" value={form.voltagem} onChange={handleChange} />
                    <InputField label="Capacidade (mAh)" name="capacidade" value={form.capacidade} onChange={handleChange} />
                    <InputField label="Cor" name="cor" value={form.cor} onChange={handleChange} />
                    <InputField label="Tipo" name="tipo" value={form.tipo} onChange={handleChange} />
                </>
            );
          case 'Fonte':
            return (
                <>
                    <InputField label="SKU" name="sku" required value={form.sku} onChange={handleChange} />
                    <InputField label="Voltagem (V)" name="voltagem" value={form.voltagem} onChange={handleChange} />
                    <InputField label="Amperagem (A)" name="amperagem" value={form.amperagem} onChange={handleChange} />
                    <InputField label="Potência (W)" name="potencia" value={form.potencia} onChange={handleChange} />
                    <InputField label="Conector" name="conector" value={form.conector} onChange={handleChange} />
                </>
            );
          default:
            return (
                <>
                    <InputField label="SKU" name="sku" required value={form.sku} onChange={handleChange} />
                    <InputField label="Marca" name="marca" required value={form.marca} onChange={handleChange} />
                    <InputField label="Conector" name="conector" value={form.conector} onChange={handleChange} />
                    <SelectField label="Acabamento" name="acabamento" options={['Brilhante', 'Fosco']} value={form.acabamento} onChange={handleChange} />
                    <InputField label="Tamanho" name="tamanho" required value={form.tamanho} onChange={handleChange} />
                    <InputField label="Pn" name="pn" required value={form.pn} onChange={handleChange} />
                    <InputField label="Posição do conector" name="posicaodoconector" required value={form.posicao do conector} onChange={handleChange} />
                    <InputField label="Tecnologia" name="tecnologia" required value={form.tecnologia} onChange={handleChange} />
                    
                    
                </>
            );
        }
      };

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm" onClick={onClose}>
          <div className="bg-white rounded-lg shadow-xl w-full max-w-4xl overflow-hidden flex flex-col max-h-[90vh]" onClick={e => e.stopPropagation()}>
            <div className="bg-[#16a34a] px-6 py-4 flex justify-between items-center shrink-0">
               <h2 className="text-xl font-bold text-white">{productToEdit ? 'Editar' : 'Novo'} {tipoProduto}</h2>
               <button onClick={onClose} className="text-white hover:text-green-200">✕</button>
            </div>
            <div className="p-6 overflow-y-auto modal-scroll bg-white">
              <div className="border border-gray-200 rounded-lg p-5 mb-8 bg-white shadow-sm">
                <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Configuração Básica</label>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label className="text-xs text-gray-500 block mb-1">Categoria</label><select className="w-full border p-2 rounded bg-gray-50" value={tipoProduto} onChange={handleTypeChange} disabled={!!productToEdit}>{Object.values(Category).map(c => <option key={c} value={c}>{c}</option>)}</select></div>
                    <div><label className="text-xs text-gray-500 block mb-1">Nome Personalizado</label><input name="nome" value={form.nome || ''} onChange={handleChange} className="w-full border p-2 rounded" placeholder="Automático se vazio" /></div>
                </div>
              </div>
              <form onSubmit={handleSubmit}>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">{renderFields()}</div>
                <div className="border-t border-gray-100 pt-6">
                    <h3 className="text-sm font-bold text-gray-700 uppercase mb-4">Galeria</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <InputField label="Foto 1" name="foto1" placeholder="URL..." value={form.foto1} onChange={handleChange} />
                        <InputField label="Foto 2" name="foto2" placeholder="URL..." value={form.foto2} onChange={handleChange} />
                        <InputField label="Foto 3" name="foto3" placeholder="URL..." value={form.foto3} onChange={handleChange} />
                        <InputField label="Foto 4" name="foto4" placeholder="URL..." value={form.foto4} onChange={handleChange} />
                    </div>
                </div>
              </form>
            </div>
            <div className="border-t border-gray-100 p-6 bg-white shrink-0 flex justify-end gap-3">
               <button onClick={onClose} className="px-6 py-2 border rounded hover:bg-gray-50 text-gray-700">Cancelar</button>
               <button onClick={handleSubmit} className="px-6 py-2 bg-[#16a34a] text-white rounded font-bold hover:bg-green-700 shadow-lg">Salvar Produto</button>
            </div>
          </div>
        </div>
      );
    };

    const ToastContainer = ({ toasts, removeToast }) => (
      <div className="fixed top-5 right-5 z-[100] flex flex-col gap-3">
        {toasts.map((toast) => (
          <div key={toast.id} onClick={() => removeToast(toast.id)} className={`min-w-[300px] px-4 py-3 rounded shadow-lg text-white text-sm font-medium flex justify-between items-center cursor-pointer animate-fade-in ${toast.type === 'error' ? 'bg-red-500' : 'bg-green-600'}`}>
            <span>{toast.msg}</span><span className="font-bold ml-4 text-white/70 hover:text-white">✕</span>
          </div>
        ))}
      </div>
    );

    const LoginScreen = ({ onLogin }) => {
      const [email, setEmail] = useState("");
      const [password, setPassword] = useState("");
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(""); 

      const submit = async (e) => {
        e.preventDefault(); setError(""); setLoading(true);
        const result = await Server.login(email, password);
        setLoading(false);
        if (result) {
          localStorage.setItem("authToken", result.token);
          localStorage.setItem("loginTime", Date.now());
          onLogin();
        } else {
          setError("Email ou senha incorretos. Tente novamente.");
        }
      };

      return (
        <div className="min-h-screen flex items-center justify-center bg-gray-100">
          <div className="bg-white p-8 rounded-xl shadow-lg w-96">
            <h1 className="text-2xl font-bold text-center text-green-700 mb-6">bringIT Admin</h1>
            <form onSubmit={submit} className="space-y-4">
              <input value={email} onChange={(e) => { setEmail(e.target.value); setError(""); }} className={`w-full border p-2 rounded ${error ? 'border-red-500' : 'border-gray-300'}`} placeholder="Email" type="email" />
              <div>
                <input type="password" value={password} onChange={(e) => { setPassword(e.target.value); setError(""); }} className={`w-full border p-2 rounded ${error ? 'border-red-500' : 'border-gray-300'}`} placeholder="Senha" />
                {error && <p className="text-red-500 text-xs mt-1 font-semibold animate-fade-in">{error}</p>}
              </div>
              <button disabled={loading} className="w-full bg-green-600 text-white p-2 rounded hover:bg-green-700 font-bold transition-colors">{loading ? "Entrando..." : "Entrar"}</button>
            </form>
          </div>
        </div>
      );
    };

    const Dashboard = ({ products }) => {
      const cats = products.reduce((acc, p) => { acc[p.categoria] = (acc[p.categoria]||0)+1; return acc; }, {});
      return (
        <div className="animate-fade-in">
          <h2 className="text-2xl font-bold text-gray-800 mb-6">Visão Geral</h2>
          <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200"><p className="text-gray-500 text-sm font-bold uppercase">Total</p><p className="text-3xl font-bold text-gray-900 mt-2">{products.length}</p></div>
            {Object.keys(cats).map(c => (<div key={c} className="bg-white p-6 rounded-xl shadow-sm border border-gray-200"><p className="text-gray-500 text-sm font-bold uppercase truncate">{c}</p><p className="text-3xl font-bold text-gray-900 mt-2">{cats[c]}</p></div>))}
          </div>
        </div>
      );
    };

    // --- APP PRINCIPAL ---
    const App = () => {
      const [token, setToken] = useState(localStorage.getItem('authToken'));
      const [products, setProducts] = useState([]);
      const [filteredProducts, setFilteredProducts] = useState([]);
      const [currentView, setCurrentView] = useState('dashboard');
      const [selectedCategory, setSelectedCategory] = useState('Todos');
      const [isProductsSubmenuOpen, setIsProductsSubmenuOpen] = useState(true);
      const [searchQuery, setSearchQuery] = useState('');
      const [specFilters, setSpecFilters] = useState({});
      const [selectedProduct, setSelectedProduct] = useState(null);
      
      const [isFormModalOpen, setIsFormModalOpen] = useState(false);
      const [productToEdit, setProductToEdit] = useState(null);
      const [isImportModalOpen, setIsImportModalOpen] = useState(false);
      
      const [productToDelete, setProductToDelete] = useState(null);
      const [toasts, setToasts] = useState([]);

      // --- NOVOS ESTADOS DE PAGINAÇÃO ---
      const [currentPage, setCurrentPage] = useState(1);
      const [itemsPerPage, setItemsPerPage] = useState(20);

      const notify = (msg, type = 'success') => {
        const id = Date.now();
        setToasts((prev) => [...prev, { id, msg, type }]);
        setTimeout(() => setToasts((prev) => prev.filter((t) => t.id !== id)), 4000);
      };
      const removeToast = (id) => setToasts((prev) => prev.filter((t) => t.id !== id));

      const fetchProducts = useCallback(async () => {
         try { const data = await Server.getProducts(); setProducts(data); } catch (e) { console.error(e); }
      }, []);

      useEffect(() => { if (token) fetchProducts(); }, [token, fetchProducts]);

      const handleCategoryChange = (cat) => { setSelectedCategory(cat); setSpecFilters({}); setCurrentView('products'); setCurrentPage(1); };
      const handleSpecFilterChange = (field, value) => { setSpecFilters(prev => ({ ...prev, [field]: value })); setCurrentPage(1); };
      
      const handleSaveProduct = async (productData) => { fetchProducts(); setCurrentView('products'); };
      const handleImportBatch = async (batchData) => {
        if (!token) return;
        try { const count = await Server.addBatch(token, batchData); notify(`${count} importados!`, 'success'); fetchProducts(); }
        catch (e) { notify("Erro: " + e.message, 'error'); }
      };

      const confirmDelete = async () => {
         if (!productToDelete) return;
         try {
             await Server.removeProduct(token, productToDelete.id, productToDelete.categoria);
             notify("Produto removido com sucesso", 'success');
             fetchProducts();
         } catch (e) {
             notify("Erro ao remover: " + e.message, 'error');
         }
         setProductToDelete(null);
      };

      const handleRequestDelete = (e, product) => {
         e.stopPropagation();
         setProductToDelete(product);
      };

      const logout = async () => { 
        try { if (auth) await auth.signOut(); } catch (e) {}
        localStorage.removeItem('authToken'); setToken(null); 
      };

      useEffect(() => {
        let result = products;
        if (selectedCategory !== 'Todos') result = result.filter(p => p.categoria === selectedCategory);
        if (selectedCategory !== 'Todos') {
             Object.entries(specFilters).forEach(([key, value]) => {
                 if (value) result = result.filter(p => p.especificacoes && p.especificacoes[key] && String(p.especificacoes[key]).toLowerCase() === value.toLowerCase());
             });
        }
        if (searchQuery) {
          const q = searchQuery.toLowerCase();
          result = result.filter(p => (p.nome||'').toLowerCase().includes(q) || (p.descricao||'').toLowerCase().includes(q) || (p.especificacoes?.sku||'').toLowerCase().includes(q) || (p.especificacoes && Object.values(p.especificacoes).some(v => String(v).toLowerCase().includes(q))));
          setCurrentPage(1); 
        }
        setFilteredProducts(result);
      }, [products, selectedCategory, searchQuery, specFilters]);

      // --- CÁLCULO DA PAGINAÇÃO ---
      const indexOfLastItem = currentPage * itemsPerPage;
      const indexOfFirstItem = indexOfLastItem - itemsPerPage;
      const currentProducts = filteredProducts.slice(indexOfFirstItem, indexOfLastItem);
      const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);

      const openEditModal = (e, product) => { e.stopPropagation(); setProductToEdit(product); setIsFormModalOpen(true); };
      const openNewModal = () => { setProductToEdit(null); setIsFormModalOpen(true); };

      if (!token) return <LoginScreen onLogin={() => setToken(localStorage.getItem('authToken'))} />;

      return (
        <div className="flex min-h-screen bg-gray-50 font-inter">
          <ToastContainer toasts={toasts} removeToast={removeToast} />
          
          <aside className="w-64 bg-white fixed h-full shadow-lg z-20 flex flex-col hidden md:flex">
             <div className="p-6 border-b border-gray-100">
               <div className="flex items-center gap-2 text-green-700">
                 <div className="text-2xl text-green-700 p-1.5 rounded-lg font-bold">bringIT</div>
                 <h1 className="text-xs">CustomerSuccess</h1>
               </div>
             </div>
             <nav className="flex-1 py-6 overflow-y-auto">
               <ul>
                 <li className={`flex items-center gap-3 px-4 py-3 cursor-pointer transition-all border-r-4 ${currentView === 'dashboard' ? 'bg-green-50 text-green-700 border-green-600 font-medium' : 'text-gray-600 border-transparent hover:bg-gray-50'}`} onClick={() => setCurrentView('dashboard')}>
                   <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6z" /></svg><span>Dashboard</span>
                 </li>
                 <li>
                   <div className="flex items-center justify-between px-4 py-3 cursor-pointer text-gray-600 hover:text-gray-900" onClick={() => setIsProductsSubmenuOpen(!isProductsSubmenuOpen)}>
                     <div className="flex items-center gap-3"><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg><span>Produtos</span></div>
                     <svg className={`w-4 h-4 transition-transform ${isProductsSubmenuOpen ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" /></svg>
                   </div>
                   {isProductsSubmenuOpen && (
                     <ul className="bg-gray-50/50 py-2 space-y-1">
                       <li className={`flex items-center gap-3 px-4 py-2 text-sm cursor-pointer border-r-4 pl-12 ${currentView === 'products' && selectedCategory === 'Todos' ? 'bg-green-50 text-green-700 border-green-600 font-medium' : 'text-gray-600 border-transparent hover:bg-gray-50'}`} onClick={() => handleCategoryChange('Todos')}>Todos</li>
                       {Object.values(Category).map(cat => (
                         <li key={cat} className={`flex items-center gap-3 px-4 py-2 text-sm cursor-pointer border-r-4 pl-12 ${currentView === 'products' && selectedCategory === cat ? 'bg-green-50 text-green-700 border-green-600 font-medium' : 'text-gray-600 border-transparent hover:bg-gray-50'}`} onClick={() => handleCategoryChange(cat)}>{cat}</li>
                       ))}
                     </ul>
                   )}
                 </li>
               </ul>
             </nav>
             <div className="p-4 border-t border-gray-100">
                <button onClick={logout} className="flex items-center gap-3 px-4 py-2 w-full text-sm font-medium text-red-600 rounded-lg hover:bg-red-50 transition-colors">
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                  <span>Sair do Sistema</span>
                </button>
             </div>
          </aside>

          <main className="flex-1 ml-0 md:ml-64 p-6 md:p-8 transition-all">
             <div className="md:hidden mb-4 flex justify-between items-center bg-white p-4 rounded-lg shadow-sm">
                <span className="font-bold text-green-600">bringIT</span><button onClick={logout} className="text-sm text-red-500">Sair</button>
             </div>
             <div className="hidden md:flex justify-end mb-4">
                 <button onClick={logout} className="flex items-center gap-2 text-gray-500 hover:text-red-600 transition-colors bg-white px-4 py-2 rounded-lg shadow-sm border border-gray-100 hover:border-red-100 text-sm font-medium">
                     <span>Sair do Sistema</span>
                     <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                 </button>
             </div>

             {currentView === 'dashboard' && <Dashboard products={products} />}
             {currentView === 'products' && (
                <div className="animate-fade-in">
                  <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                     <div><h2 className="text-2xl font-bold text-gray-800">{selectedCategory === 'Todos' ? 'Catálogo' : selectedCategory}</h2><p className="text-gray-500 text-sm mt-1">Gerencie seu estoque.</p></div>
                     <div className="flex gap-2">
                       <button onClick={() => setIsImportModalOpen(true)} className="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 shadow-sm flex items-center gap-2 font-bold text-sm">Importar Lote</button>
                       <button onClick={openNewModal} className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 shadow-sm flex items-center gap-2 font-bold text-sm">+ Novo</button>
                     </div>
                  </div>
                  <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-6 relative">
                      <input type="text" placeholder="Buscar por Nome, SKU ou Descrição..." className="w-full border border-gray-200 bg-gray-50 rounded-lg pl-10 pr-10 py-3 focus:bg-white focus:ring-2 focus:ring-green-100 outline-none" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} />
                      <svg className="absolute left-7 top-7 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                      {searchQuery && <button onClick={() => setSearchQuery('')} className="absolute right-7 top-7 text-gray-400">&times;</button>}
                  </div>
                  
                  {/* BARRA DE FILTROS AGORA INCLUI A PAGINAÇÃO */}
                  <FilterBar 
                    category={selectedCategory} 
                    products={products} 
                    activeFilters={specFilters} 
                    onFilterChange={handleSpecFilterChange} 
                    currentPage={currentPage}
                    totalPages={totalPages}
                    itemsPerPage={itemsPerPage}
                    onItemsPerPageChange={(val) => { setItemsPerPage(val); setCurrentPage(1); }}
                    onPageChange={setCurrentPage}
                    totalItems={filteredProducts.length}
                  />
                  
                  <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                      {currentProducts.length === 0 && <div className="col-span-full text-center py-10 text-gray-500">Nenhum produto encontrado.</div>}
                      {currentProducts.map((product) => (
                        <div key={product.id} onClick={() => setSelectedProduct(product)} className="bg-white rounded-xl shadow-sm border border-gray-100 hover:shadow-lg transition-all cursor-pointer group flex flex-col h-full overflow-hidden">
                           <div className="relative h-48 bg-gray-50">
                             <img src={product.imagens && product.imagens.length > 0 ? product.imagens[0] : 'https://placehold.co/400x300?text=Sem+Imagem'} alt={product.nome} className="w-full h-full object-contain p-2 group-hover:scale-105 transition-transform duration-500" />
                             <span className="absolute top-3 left-3 bg-white/90 text-gray-800 text-xs font-bold px-2 py-1 rounded shadow-sm">{product.categoria}</span>
                           </div>
                           <div className="p-5 flex flex-col flex-1">
                             <h3 className="font-bold text-gray-800 mb-2 line-clamp-2 text-sm">{product.nome}</h3>
                             <p className="text-xs text-gray-500 mb-4 line-clamp-2 flex-1">{product.descricao}</p>
                             <div className="flex justify-between items-center pt-4 border-t border-gray-50 mt-auto">
                               <span className="text-xs text-green-600 font-bold hover:underline uppercase">Ver Detalhes</span>
                               <div className="flex gap-2">
                                 <button onClick={(e) => openEditModal(e, product)} className="text-gray-400 hover:text-blue-500 hover:bg-blue-50 p-1.5 rounded-full transition-colors"><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg></button>
                                 <button onClick={(e) => handleRequestDelete(e, product)} className="text-gray-400 hover:text-red-500 hover:bg-red-50 p-1.5 rounded-full transition-colors"><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                               </div>
                             </div>
                           </div>
                        </div>
                      ))}
                  </div>
                </div>
             )}
          </main>

          <ProductModal product={selectedProduct} onClose={() => setSelectedProduct(null)} />
          <ProductFormModal isOpen={isFormModalOpen} onClose={() => setIsFormModalOpen(false)} onSave={handleSaveProduct} productToEdit={productToEdit} notify={notify} />
          <ImportModal isOpen={isImportModalOpen} onClose={() => setIsImportModalOpen(false)} onImport={handleImportBatch} notify={notify} />
          <DeleteModal isOpen={!!productToDelete} onClose={() => setProductToDelete(null)} onConfirm={confirmDelete} productName={productToDelete?.nome} />
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>














