<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Produtos - bringIT System</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- ========================
       FIREBASE v8 (CDN) - must be loaded BEFORE Babel/React
       ======================== -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    // sua firebaseConfig (conforme voc√™ enviou)
    const firebaseConfig = {
      apiKey: "AIzaSyAHp6za_KGlDvUEL4GnMLUK5llOgCOdMMk",
      authDomain: "produtos-a5d81.firebaseapp.com",
      projectId: "produtos-a5d81",
      storageBucket: "produtos-a5d81.firebasestorage.app",
      messagingSenderId: "841903119824",
      appId: "1:841903119824:web:48cefee322161840eb2dd5",
      measurementId: "G-YBH3SGYPC8"
    };

    try {
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const firestore = firebase.firestore();
      // Exponha globalmente para o c√≥digo Babel/React abaixo
      window._firebaseAuth = auth;
      window._firebaseFirestore = firestore;
      console.log("‚úÖ Firebase v8 + Firestore inicializado");
    } catch (err) {
      console.error("Erro ao inicializar Firebase:", err);
    }
  </script>

  <!-- React / Babel (dev builds) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .modal-scroll::-webkit-scrollbar { width: 8px; }
    .modal-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
    .modal-scroll::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
    .modal-scroll::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel" data-presets="typescript,react">
    const { useState, useEffect, useCallback, useMemo } = React;

    // Pegue o auth e firestore inicializados no escopo global
    const auth = window._firebaseAuth;
    const firestore = window._firebaseFirestore;

    // --- CONSTANTES ---
    const Category = {
      SCREEN: 'Tela',
      BATTERY: 'Bateria',
      KEYBOARD: 'Teclado',
      POWER_SUPPLY: 'Fonte'
    };

    // Configura√ß√£o de quais campos filtrar por categoria
    const FILTERS_CONFIG = {
        [Category.SCREEN]: ['tamanho', 'resolucao', 'iluminacao', 'conector', 'fixacao', 'acabamento'],
        [Category.BATTERY]: ['voltagem', 'capacidade', 'cor', 'tipo'],
        [Category.KEYBOARD]: ['cor', 'idioma', 'moldura', 'backlight', 'marca'],
        [Category.POWER_SUPPLY]: ['voltagem', 'amperagem', 'potencia', 'conector']
    };

    // --- SERVIDOR (FIRESTORE) ---
    const Server = {
      // login via Firebase Auth v8
      login: async (email, password) => {
        if (!auth) {
          console.error("Auth do Firebase n√£o est√° dispon√≠vel");
          return null;
        }
        try {
          const userCred = await auth.signInWithEmailAndPassword(email, password);
          const token = await userCred.user.getIdToken();
          return { token, uid: userCred.user.uid };
        } catch (e) {
          console.warn("Falha no signIn:", e && e.code ? e.code : e);
          return null;
        }
      },

      isAuthenticated: (token) => !!token,

      // retorna todos os produtos de todas as categorias em um array
      getProducts: async () => {
        if (!firestore) {
          console.warn("Firestore n√£o inicializado");
          return [];
        }
        try {
          const categorias = Object.values(Category);
          const all = [];
          // busca cada categoria e seus produtos
          for (const cat of categorias) {
            const colRef = firestore.collection('categorias').doc(cat).collection('produtos');
            const snap = await colRef.get();
            snap.forEach(doc => {
              const data = doc.data();
              all.push({
                id: doc.id,
                ...data,
                categoria: cat,
                imagens: Array.isArray(data.imagens) ? data.imagens : (data.imagens ? [data.imagens] : [])
              });
            });
          }
          // ordena por nome (numeric natural)
          return all.sort((a,b) => {
            const textoA = a.nome || '';
            const textoB = b.nome || '';
            return textoA.localeCompare(textoB, undefined, { numeric: true, sensitivity: 'base' });
          });
        } catch (e) {
          console.error("Erro ao buscar produtos do Firestore:", e);
          return [];
        }
      },

      addProduct: async (token, product) => {
        if (!firestore) throw new Error("Firestore n√£o inicializado");
        const { id, ...rest } = product;
        const categoria = product.categoria || Category.SCREEN;
        const colRef = firestore.collection('categorias').doc(categoria).collection('produtos');
        const now = firebase.firestore.FieldValue.serverTimestamp();
        const payload = { ...rest, criadoEm: now };
        const docRef = await colRef.add(payload);
        const docSnap = await docRef.get();
        return { id: docRef.id, ...docSnap.data(), categoria };
      },

      updateProduct: async (token, product) => {
        if (!firestore) throw new Error("Firestore n√£o inicializado");
        const { id, categoria, ...rest } = product;
        if (!id || !categoria) throw new Error("Produto precisa de id e categoria para atualizar");
        const docRef = firestore.collection('categorias').doc(categoria).collection('produtos').doc(id);
        await docRef.set(rest, { merge: true });
        const snap = await docRef.get();
        return { id: snap.id, ...snap.data(), categoria };
      },

      addBatch: async (token, productsArray) => {
        if (!firestore) throw new Error("Firestore n√£o inicializado");
        const batch = firestore.batch(); // usa batch para atomicidade
        let count = 0;
        for (const p of productsArray) {
          const categoria = p.categoria || Category.SCREEN;
          const colRef = firestore.collection('categorias').doc(categoria).collection('produtos');
          const newDocRef = colRef.doc(); // gera id
          const { id, ...rest } = p;
          batch.set(newDocRef, { ...rest, criadoEm: firebase.firestore.FieldValue.serverTimestamp() });
          count++;
        }
        await batch.commit();
        return count;
      },

      removeProduct: async (token, id, categoria) => {
        if (!firestore) throw new Error("Firestore n√£o inicializado");
        if (!id || !categoria) throw new Error("Para remover informe id e categoria");
        await firestore.collection('categorias').doc(categoria).collection('produtos').doc(id).delete();
        return true;
      }
    };

    // --- COMPONENTES UI GEN√âRICOS ---
    const InputField = ({ label, name, placeholder, required, value, onChange, colSpan = 1 }) => (
      <div className={colSpan > 1 ? `col-span-${colSpan} md:col-span-${colSpan}` : ''}>
        <label className="block text-sm font-semibold text-gray-600 mb-1">{label} {required && <span className="text-red-500">*</span>}</label>
        <input type="text" name={name} value={value || ''} onChange={onChange} placeholder={placeholder} className="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-green-500 focus:border-green-500 placeholder-gray-400 transition-shadow" />
      </div>
    );
    const SelectField = ({ label, name, options, value, onChange }) => (
      <div>
        <label className="block text-sm font-semibold text-gray-600 mb-1">{label}</label>
        <div className="relative">
          <select name={name} value={value || ''} onChange={onChange} className="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-green-500 focus:border-green-500 appearance-none bg-white text-gray-700">
            <option value="">Selecione...</option>{options.map(opt => <option key={opt} value={opt}>{opt}</option>)}
          </select>
          <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500"><svg className="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" /></svg></div>
        </div>
      </div>
    );

    // --- COMPONENTES DE FILTRO ---
    const FilterBar = ({ category, products, activeFilters, onFilterChange }) => {
        if (category === 'Todos') return null;

        const fieldsToShow = FILTERS_CONFIG[category] || [];
        if (fieldsToShow.length === 0) return null;

        const filterOptions = useMemo(() => {
            const options = {};
            fieldsToShow.forEach(field => {
                const values = new Set();
                products.forEach(p => {
                    if (p.categoria === category && p.especificacoes && p.especificacoes[field]) {
                        values.add(p.especificacoes[field]);
                    }
                });
                options[field] = Array.from(values).sort();
            });
            return options;
        }, [category, products]);

        return (
            <div className="bg-white border border-gray-200 rounded-lg p-4 mb-6 shadow-sm animate-fade-in">
                <div className="flex items-center gap-2 mb-3 text-gray-700">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" /></svg>
                    <h3 className="text-sm font-bold uppercase">Filtrar {category}</h3>
                </div>
                <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                    {fieldsToShow.map(field => (
                        <div key={field}>
                            <label className="block text-xs font-semibold text-gray-500 mb-1 capitalize">{field.replace('_', ' ')}</label>
                            <select 
                                className="w-full border border-gray-300 rounded text-xs py-1.5 px-2 focus:ring-1 focus:ring-green-500 outline-none bg-gray-50"
                                value={activeFilters[field] || ''}
                                onChange={(e) => onFilterChange(field, e.target.value)}
                            >
                                <option value="">Todos</option>
                                {filterOptions[field] && filterOptions[field].map(val => (
                                    <option key={val} value={val}>{val}</option>
                                ))}
                            </select>
                        </div>
                    ))}
                    {Object.keys(activeFilters).some(k => activeFilters[k]) && (
                        <div className="flex items-end">
                            <button 
                                onClick={() => {
                                    const cleared = {};
                                    fieldsToShow.forEach(f => cleared[f] = '');
                                    fieldsToShow.forEach(f => onFilterChange(f, ''));
                                }} 
                                className="text-xs text-red-500 hover:text-red-700 underline pb-2"
                            >
                                Limpar
                            </button>
                        </div>
                    )}
                </div>
            </div>
        );
    };

    // --- MODAIS (Mantidos originais com pequenas otimiza√ß√µes) ---
    const ImportModal = ({ isOpen, onClose, onImport }) => {
      if (!isOpen) return null;
      const [jsonText, setJsonText] = useState('');
      const [error, setError] = useState('');
      const handleImport = () => {
        try {
          const parsed = JSON.parse(jsonText);
          if (!Array.isArray(parsed)) throw new Error("O formato deve ser uma lista (Array).");
          onImport(parsed); onClose(); setJsonText(''); setError('');
        } catch (e) { setError("Erro no JSON: " + e.message); }
      };
      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm" onClick={onClose}>
          <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl overflow-hidden flex flex-col" onClick={e => e.stopPropagation()}>
            <div className="bg-indigo-600 px-6 py-4 flex justify-between items-center"><h2 className="text-xl font-bold text-white">Importar em Lote</h2><button onClick={onClose} className="text-white hover:text-indigo-200">‚úï</button></div>
            <div className="p-6">
              <textarea className="w-full h-64 border border-gray-300 rounded p-3 font-mono text-xs focus:ring-2 focus:ring-indigo-500 outline-none" value={jsonText} onChange={e => setJsonText(e.target.value)} placeholder='[{"nome": "...", "categoria":"Tela", "especificacoes": {...}}, ...]' />
              {error && <p className="text-red-500 text-xs mt-2 font-bold">{error}</p>}
            </div>
            <div className="bg-gray-50 px-6 py-4 flex justify-end gap-3"><button onClick={onClose} className="px-4 py-2 text-gray-600 hover:bg-gray-200 rounded">Cancelar</button><button onClick={handleImport} className="px-4 py-2 bg-indigo-600 text-white font-bold rounded hover:bg-indigo-700">Importar</button></div>
          </div>
        </div>
      );
    };

    const ProductModal = ({ product, onClose }) => {
      if (!product) return null;
      
      const [activeImage, setActiveImage] = useState(product.imagens ? product.imagens[0] : "");
      const [isZoomed, setIsZoomed] = useState(false);

      useEffect(() => { 
          if(product && product.imagens && product.imagens.length > 0) setActiveImage(product.imagens[0]); 
      }, [product]);

      return (
        <>
          <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in" onClick={onClose}>
            <div className="bg-white rounded-lg shadow-2xl w-full max-w-5xl overflow-hidden flex flex-col" onClick={e => e.stopPropagation()}>
              <div className="bg-[#16a34a] px-6 py-4 flex justify-between items-center shrink-0">
                <h2 className="text-xl font-bold text-white">{product.nome}</h2>
                <button onClick={onClose} className="text-white hover:text-green-200 font-bold text-xl">‚úï</button>
              </div>
              
              <div className="p-8 overflow-y-auto modal-scroll max-h-[85vh]">
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                  <div className="flex flex-col">
                    <div 
                        className="w-full h-96 rounded-lg overflow-hidden border border-gray-200 mb-4 bg-white flex items-center justify-center relative shadow-sm group cursor-zoom-in"
                        onClick={() => setIsZoomed(true)}
                        title="Clique para ampliar em tela cheia"
                    >
                      {activeImage ? (
                          <img 
                            src={activeImage} 
                            alt={product.nome} 
                            className="w-full h-full object-contain p-2 transition-transform duration-300 group-hover:scale-110" 
                          />
                      ) : (
                          <span className="text-gray-400">Sem imagem</span>
                      )}
                      
                      <div className="absolute bottom-2 right-2 bg-black/50 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity">
                        Clique para ampliar üîç
                      </div>
                    </div>
                    
                    <div className="flex gap-3 mb-6 overflow-x-auto py-2">
                      {product.imagens && product.imagens.map((img, idx) => (
                        <div key={idx} onClick={() => setActiveImage(img)} 
                             className={`w-20 h-20 rounded-md overflow-hidden cursor-pointer border-2 transition-all flex-shrink-0 bg-white
                             ${activeImage === img ? 'border-green-500 ring-2 ring-green-100 scale-105' : 'border-gray-200 hover:border-green-300 opacity-80 hover:opacity-100'}`}>
                          <img src={img} className="w-full h-full object-contain p-1" />
                        </div>
                      ))}
                    </div>
                    
                    <div className="mt-auto self-start">
                        <span className="bg-gray-100 text-gray-700 px-4 py-1.5 rounded-full text-sm font-semibold border border-gray-200 shadow-sm">
                          {product.categoria}
                        </span>
                    </div>
                  </div>

                  <div>
                    <h3 className="text-lg font-bold text-gray-900 mb-3 border-b pb-2">Especifica√ß√µes T√©cnicas</h3>
                    <div className="rounded-lg border border-gray-100 overflow-hidden text-sm shadow-sm">
                      {product.especificacoes && ORDEM_ESPECS.filter(k => product.especificacoes[k]).map((key, index) => (
                      <div key={key} className={`flex justify-between py-3 px-4 ${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'}`}>
                        <span className="font-bold text-gray-600 capitalize">{key.replace(/_/g, ' ')}:</span>
                        <span className="text-gray-800 text-right ml-4 font-medium">{product.especificacoes[key]}</span>
                      </div>
                    ))}

                      {(!product.especificacoes || Object.keys(product.especificacoes).length === 0) && (
                          <div className="p-4 text-gray-400 text-center italic">Sem especifica√ß√µes cadastradas.</div>
                      )}
                    </div>
                    
                    <div className="mt-6 bg-blue-50 p-4 rounded-lg border border-blue-100">
                        <h4 className="text-blue-800 font-bold text-sm mb-1">Descri√ß√£o Interna</h4>
                        <p className="text-blue-900 text-sm">{product.descricao}</p>
                    </div>
                  </div>

                </div>
              </div>
            </div>
          </div>

          {isZoomed && (
            <div 
                className="fixed inset-0 z-[60] bg-black/95 flex items-center justify-center p-4 animate-fade-in"
                onClick={() => setIsZoomed(false)}
            >
                <button 
                    onClick={() => setIsZoomed(false)}
                    className="absolute top-5 right-5 text-white/70 hover:text-white text-5xl font-light focus:outline-none z-50"
                >
                    &times;
                </button>

                <img 
                    src={activeImage} 
                    className="max-w-full max-h-full object-contain shadow-2xl rounded-sm"
                    onClick={(e) => e.stopPropagation()}
                />
                
                <p className="absolute bottom-5 text-white/50 text-sm">Pressione ESC ou clique fora para fechar</p>
            </div>
          )}
        </>
      );
    };

    // --- MODAL ADICIONAR / EDITAR (COM 4 FOTOS) ---
    const ProductFormModal = ({ isOpen, onClose, onSave, productToEdit }) => {
      if (!isOpen) return null;
      const [tipoProduto, setTipoProduto] = useState('Tela');
      const [form, setForm] = useState({});

      useEffect(() => {
        if (productToEdit) {
          setTipoProduto(productToEdit.categoria);
          const imgs = productToEdit.imagens || [];
          setForm({
            nome: productToEdit.nome,
            foto1: imgs[0] || '',
            foto2: imgs[1] || '',
            foto3: imgs[2] || '',
            foto4: imgs[3] || '',
            ...productToEdit.especificacoes
          });
        } else {
          setTipoProduto('Tela');
          setForm({});
        }
      }, [productToEdit, isOpen]);

      const handleTypeChange = (e) => { setTipoProduto(e.target.value); if (!productToEdit) setForm({}); };
      const handleChange = (e) => { const { name, value } = e.target; setForm(prev => ({ ...prev, [name]: value })); };
      
      const handleSubmit = async (e) => {
        e.preventDefault();
        const { nome, foto1, foto2, foto3, foto4, plug_imagem, ...specs } = form;
        const mainImage = foto1 || plug_imagem;
        const imagensFinais = [mainImage, foto2, foto3, foto4].filter(img => img && img.trim() !== '');
        if (imagensFinais.length === 0) imagensFinais.push("https://placehold.co/400x300?text=Sem+Imagem");

        const productData = {
          id: productToEdit?.id,
          nome: nome || `${tipoProduto} ${form.marca || ''} ${form.modelo || ''}`,
          categoria: tipoProduto,
          descricao: `Produto ${form.marca || ''}. SKU: ${form.sku || 'N/A'}`,
          imagens: imagensFinais,
          especificacoes: specs
        };

        try {
          if (productToEdit && productToEdit.id) {
            await Server.updateProduct(localStorage.getItem('authToken'), productData);
          } else {
            await Server.addProduct(localStorage.getItem('authToken'), productData);
          }
          onSave && onSave(productData);
        } catch (err) {
          alert("Erro ao salvar: " + err.message);
        } finally {
          onClose();
          setForm({});
        }
      };

      // Campos espec√≠ficos de cada categoria
      const renderFields = () => {
        switch (tipoProduto) {
          case 'Teclado':
            return (
              <>
                <InputField label="SKU" name="sku" required value={form.sku} onChange={handleChange} />
                <InputField label="Marca" name="marca" required value={form.marca} onChange={handleChange} />
                <InputField label="Modelo" name="modelo" value={form.modelo} onChange={handleChange} />
                <InputField label="Idioma" name="idioma" value={form.idioma} onChange={handleChange} />
                <InputField label="Cor" name="cor" value={form.cor} onChange={handleChange} />
                <SelectField label="Moldura" name="moldura" options={['Com Moldura', 'Sem Moldura']} value={form.moldura} onChange={handleChange} />
                <SelectField label="Backlight" name="backlight" options={['Sim', 'N√£o']} value={form.backlight} onChange={handleChange} />
              </>
            );
          case 'Bateria':
            return (
              <>
                <InputField label="SKU" name="sku" required value={form.sku} onChange={handleChange} />
                <InputField label="Marca" name="marca" required value={form.marca} onChange={handleChange} />
                <InputField label="Voltagem (V)" name="voltagem" value={form.voltagem} onChange={handleChange} />
                <InputField label="Capacidade (mAh)" name="capacidade" value={form.capacidade} onChange={handleChange} />
                <InputField label="Cor" name="cor" value={form.cor} onChange={handleChange} />
                <InputField label="Tipo" name="tipo" value={form.tipo} onChange={handleChange} />
              </>
            );
          case 'Fonte':
            return (
              <>
                <InputField label="SKU" name="sku" required value={form.sku} onChange={handleChange} />
                <InputField label="Voltagem (V)" name="voltagem" value={form.voltagem} onChange={handleChange} />
                <InputField label="Amperagem (A)" name="amperagem" value={form.amperagem} onChange={handleChange} />
                <InputField label="Pot√™ncia (W)" name="potencia" value={form.potencia} onChange={handleChange} />
                <InputField label="Conector" name="conector" value={form.conector} onChange={handleChange} />
              </>
            );
          default: // Tela
            return (
              <>
                <InputField label="SKU" name="sku" required value={form.sku} onChange={handleChange} />
                <InputField label="Marca" name="marca" required value={form.marca} onChange={handleChange} />
                <InputField label="Tamanho" name="tamanho" value={form.tamanho} onChange={handleChange} />
                <InputField label="Resolu√ß√£o" name="resolucao" value={form.resolucao} onChange={handleChange} />
                <SelectField label="Ilumina√ß√£o" name="iluminacao" options={['LED', 'CCFL', 'OLED']} value={form.iluminacao} onChange={handleChange} />
                <InputField label="Conector" name="conector" value={form.conector} onChange={handleChange} />
                <SelectField label="Fixa√ß√£o" name="fixacao" options={['Abas', 'Sem Fixa√ß√£o']} value={form.fixacao} onChange={handleChange} />
                <SelectField label="Acabamento" name="acabamento" options={['Brilhante', 'Fosco']} value={form.acabamento} onChange={handleChange} />
              </>
            );
        }
      };

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm" onClick={onClose}>
          <div className="bg-white rounded-lg shadow-xl w-full max-w-4xl overflow-hidden flex flex-col max-h-[90vh]" onClick={e => e.stopPropagation()}>
            <div className="bg-[#16a34a] px-6 py-4 flex justify-between items-center shrink-0">
               <h2 className="text-xl font-bold text-white">{productToEdit ? 'Editar' : 'Novo'} {tipoProduto}</h2>
               <button onClick={onClose} className="text-white hover:text-green-200">‚úï</button>
            </div>
            <div className="p-6 overflow-y-auto modal-scroll bg-white">
              <div className="border border-gray-200 rounded-lg p-5 mb-8 bg-white shadow-sm">
                <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Configura√ß√£o B√°sica</label>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label className="text-xs text-gray-500 block mb-1">Categoria</label>
                        <select className="w-full border p-2 rounded bg-gray-50" value={tipoProduto} onChange={handleTypeChange} disabled={!!productToEdit}>
                        {Object.values(Category).map(c => <option key={c} value={c}>{c}</option>)}
                        </select>
                    </div>
                    <div>
                        <label className="text-xs text-gray-500 block mb-1">Nome Personalizado (Opcional)</label>
                        <input name="nome" value={form.nome || ''} onChange={handleChange} className="w-full border p-2 rounded" placeholder="Sobrescrever nome autom√°tico" />
                    </div>
                </div>
              </div>
              
              <form onSubmit={handleSubmit}>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    {renderFields()}
                </div>

                <div className="border-t border-gray-100 pt-6">
                    <h3 className="text-sm font-bold text-gray-700 uppercase mb-4 flex items-center gap-2">
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        Galeria de Imagens (URLs)
                    </h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <InputField label="Foto 1 (Principal)" name="foto1" placeholder="https://..." value={form.foto1} onChange={handleChange} />
                        <InputField label="Foto 2" name="foto2" placeholder="https://..." value={form.foto2} onChange={handleChange} />
                        <InputField label="Foto 3" name="foto3" placeholder="https://..." value={form.foto3} onChange={handleChange} />
                        <InputField label="Foto 4" name="foto4" placeholder="https://..." value={form.foto4} onChange={handleChange} />
                    </div>
                </div>
              </form>
            </div>
            <div className="border-t border-gray-100 p-6 bg-white shrink-0 flex justify-end gap-3">
               <button onClick={onClose} className="px-6 py-2 border rounded hover:bg-gray-50 text-gray-700">Cancelar</button>
               <button onClick={handleSubmit} className="px-6 py-2 bg-[#16a34a] text-white rounded font-bold hover:bg-green-700 shadow-lg">Salvar Produto</button>
            </div>
          </div>
        </div>
      );
    };

    // --- APP PRINCIPAL ---
    const App = () => {
      const [token, setToken] = useState(localStorage.getItem('authToken'));
      const [products, setProducts] = useState([]);
      const [filteredProducts, setFilteredProducts] = useState([]);
      const [currentView, setCurrentView] = useState('dashboard');
      const [selectedCategory, setSelectedCategory] = useState('Todos');
      const [isProductsSubmenuOpen, setIsProductsSubmenuOpen] = useState(true);
      const [searchQuery, setSearchQuery] = useState('');
      
      // Estado para filtros espec√≠ficos
      const [specFilters, setSpecFilters] = useState({});

      const [selectedProduct, setSelectedProduct] = useState(null);
      const [isFormModalOpen, setIsFormModalOpen] = useState(false);
      const [productToEdit, setProductToEdit] = useState(null);
      const [isImportModalOpen, setIsImportModalOpen] = useState(false);

      const fetchProducts = useCallback(async () => {
        try { const data = await Server.getProducts(); setProducts(data); } catch (e) { console.error(e); }
      }, []);

      useEffect(() => { if (token) fetchProducts(); }, [token, fetchProducts]);

      // Fun√ß√£o para resetar filtros ao trocar categoria
      const handleCategoryChange = (cat) => {
          setSelectedCategory(cat);
          setSpecFilters({}); // Reseta filtros espec√≠ficos
          setCurrentView('products');
      };

      const handleSpecFilterChange = (field, value) => {
          setSpecFilters(prev => ({ ...prev, [field]: value }));
      };

      // EFEITO DE FILTRAGEM UNIFICADO
      useEffect(() => {
        let result = products;

        // 1. Filtro por Categoria
        if (selectedCategory !== 'Todos') {
          result = result.filter(p => p.categoria === selectedCategory);
        }

        // 2. Filtro por Especifica√ß√µes (Filtros de Select)
        if (selectedCategory !== 'Todos') {
             Object.entries(specFilters).forEach(([key, value]) => {
                 if (value && value !== '') {
                     result = result.filter(p => 
                         p.especificacoes && 
                         p.especificacoes[key] && 
                         String(p.especificacoes[key]).toLowerCase() === value.toLowerCase()
                     );
                 }
             });
        }

        // 3. Filtro por Texto (Busca geral)
        if (searchQuery) {
          const lowerQuery = searchQuery.toLowerCase();
          result = result.filter(p => {
            const nome = p.nome ? p.nome.toLowerCase() : '';
            const desc = p.descricao ? p.descricao.toLowerCase() : '';
            const sku = p.especificacoes?.sku ? String(p.especificacoes.sku).toLowerCase() : '';
            
            if (nome.includes(lowerQuery) || desc.includes(lowerQuery) || sku.includes(lowerQuery)) return true;
            
            // Busca profunda nas especifica√ß√µes
            if (p.especificacoes) {
              return Object.values(p.especificacoes).some(val => val && String(val).toLowerCase().includes(lowerQuery));
            }
            return false;
          });
        }

        setFilteredProducts(result);
      }, [products, selectedCategory, searchQuery, specFilters]);

      const logout = async () => { 
        try {
          if (auth) await auth.signOut();
        } catch (e) { console.warn("Erro no signOut:", e); }
        localStorage.removeItem('authToken'); 
        setToken(null); 
      };

      const handleSaveProduct = async (productData) => {
        if (!token) return;
        try { 
          if (productData.id) await Server.updateProduct(token, productData);
          else await Server.addProduct(token, productData); 
          fetchProducts(); 
          setCurrentView('products'); 
        } catch (e) { alert("Erro: " + e.message); }
      };

      const handleImportBatch = async (batchData) => {
        if (!token) return;
        try { 
          const count = await Server.addBatch(token, batchData); 
          alert(`${count} importados!`);
          fetchProducts(); 
        } catch (e) { alert("Erro: " + e.message); }
      };

      const handleRemoveProduct = async (e, id, categoria) => {
        e.stopPropagation();
        if (confirm("Remover?")) { 
            try { await Server.removeProduct(token, id, categoria); fetchProducts(); }
            catch(e) { alert("Erro: " + e.message); }
        }
      };

      const openEditModal = (e, product) => { e.stopPropagation(); setProductToEdit(product); setIsFormModalOpen(true); };
      const openNewModal = () => { setProductToEdit(null); setIsFormModalOpen(true); };

      const LoginScreen = ({ onLogin }) => {
        const [email, setEmail] = useState("");
        const [password, setPassword] = useState("");
        const [loading, setLoading] = useState(false);

        const submit = async (e) => {
          e.preventDefault();
          setLoading(true);

          const result = await Server.login(email, password);
          setLoading(false);

          if (result) {
            localStorage.setItem("authToken", result.token);
            onLogin();
          } else {
            alert("Email ou senha inv√°lidos.");
          }
        };

        return (
          <div className="min-h-screen flex items-center justify-center bg-gray-100">
            <div className="bg-white p-8 rounded-xl shadow-lg w-96">
              <h1 className="text-2xl font-bold text-center text-green-700 mb-6">
                bringIT Admin
              </h1>

              <form onSubmit={submit} className="space-y-4">
                <input
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  className="w-full border p-2 rounded"
                  placeholder="Email"
                  type="email"
                />

                <input
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  className="w-full border p-2 rounded"
                  placeholder="Senha"
                />

                <button
                  disabled={loading}
                  className="w-full bg-green-600 text-white p-2 rounded hover:bg-green-700"
                >
                  {loading ? "Entrando..." : "Entrar"}
                </button>
              </form>
            </div>
          </div>
        );
      };

      const Dashboard = ({ products }) => {
        const cats = products.reduce((acc, p) => { acc[p.categoria] = (acc[p.categoria]||0)+1; return acc; }, {});
        return (
          <div className="animate-fade-in">
            <h2 className="text-2xl font-bold text-gray-800 mb-6">Vis√£o Geral</h2>
            <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
              <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200"><p className="text-gray-500 text-sm font-bold uppercase">Total</p><p className="text-3xl font-bold text-gray-900 mt-2">{products.length}</p></div>
              {Object.keys(cats).map(c => (
                <div key={c} className="bg-white p-6 rounded-xl shadow-sm border border-gray-200"><p className="text-gray-500 text-sm font-bold uppercase truncate">{c}</p><p className="text-3xl font-bold text-gray-900 mt-2">{cats[c]}</p></div>
              ))}
            </div>
          </div>
        );
      };

      if (!token) return <LoginScreen onLogin={() => setToken(localStorage.getItem('authToken'))} />;

      return (
        <div className="flex min-h-screen bg-gray-50 font-inter">
          <aside className="w-66 bg-white fixed h-full shadow-lg z-20 flex flex-col hidden md:flex ">
            <div className="p-6 border-b border-gray-100">
            <div className="flex items-center gap-2 text-green-700 " >
            <div className=" text-2xl text-green-700 p-1.5 rounded-lg font-bold">bringIT</div>
            <h1 className="text-xs">CustomerSuccess</h1>
            </div></div>
            <nav className="flex-1 py-6 overflow-y-auto ">
              <ul>
                <li className={`flex items-center gap-3 px-4 py-3 cursor-pointer transition-all duration-200 border-r-4 ${currentView === 'dashboard' ? 'bg-green-50 text-green-700 border-green-600 font-medium' : 'text-gray-600  border-transparent hover:bg-gray-50'}`} onClick={() => setCurrentView('dashboard')}>
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2z" /></svg><span>Dashboard</span>
                </li>
                <li>
                  <div className="flex items-center justify-between px-4 py-3 cursor-pointer text-gray-600 hover:text-gray-900" onClick={() => setIsProductsSubmenuOpen(!isProductsSubmenuOpen)}>
                    <div className="flex items-center gap-3"><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg><span>Produtos</span></div>
                    <svg className={`w-4 h-4 transition-transform ${isProductsSubmenuOpen ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" /></svg>
                  </div>
                  {isProductsSubmenuOpen && (
                    <ul className="bg-gray-50/50 py-2 space-y-1">
                      <li className={`flex items-center gap-3 px-4 py-2 text-sm cursor-pointer border-r-4 pl-12 ${currentView === 'products' && selectedCategory === 'Todos' ? 'bg-green-50 text-green-700 border-green-600 font-medium' : 'text-gray-600 border-transparent hover:bg-gray-50'}`} onClick={() => handleCategoryChange('Todos')}>Todos</li>
                      {Object.values(Category).map(cat => (
                         <li key={cat} className={`flex items-center gap-3 px-4 py-2 text-sm cursor-pointer border-r-4 pl-12 ${currentView === 'products' && selectedCategory === cat ? 'bg-green-50 text-green-700 border-green-600 font-medium' : 'text-gray-600 border-transparent hover:bg-gray-50'}`} onClick={() => handleCategoryChange(cat)}>{cat}</li>
                      ))}
                    </ul>
                  )}
                </li>
              </ul>
            </nav>
          </aside>

          <main className="flex-1 ml-0 md:ml-64 p-6 md:p-8 transition-all">
             <div className="md:hidden mb-4 flex justify-between items-center bg-white p-4 rounded-lg shadow-sm"><span className="font-bold text-green-600">bringIT</span><button onClick={logout} className="text-sm text-red-500">Sair</button></div>

            {currentView === 'dashboard' && <Dashboard products={products} />}
            {currentView === 'products' && (
              <div className="animate-fade-in">
                 <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                   <div><h2 className="text-2xl font-bold text-gray-800">{selectedCategory === 'Todos' ? 'Cat√°logo' : selectedCategory}</h2><p className="text-gray-500 text-sm mt-1">Gerencie seu estoque.</p></div>
                   <div className="flex gap-2">
                     <button onClick={() => setIsImportModalOpen(true)} className="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 shadow-sm flex items-center gap-2 font-bold text-sm">Importar Lote</button>
                     <button onClick={openNewModal} className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 shadow-sm flex items-center gap-2 font-bold text-sm">+ Novo</button>
                   </div>
                 </div>
                
                {/* BARRA DE BUSCA GLOBAL */}
                <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-6 relative">
                   <input type="text" placeholder="Buscar por Nome, SKU ou Descri√ß√£o..." className="w-full border border-gray-200 bg-gray-50 rounded-lg pl-10 pr-10 py-3 focus:bg-white focus:ring-2 focus:ring-green-100 outline-none" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} />
                   <svg className="absolute left-7 top-7 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                   {searchQuery && <button onClick={() => setSearchQuery('')} className="absolute right-7 top-7 text-gray-400">&times;</button>}
                </div>

                {/* FILTROS ESPEC√çFICOS POR CATEGORIA */}
                <FilterBar 
                    category={selectedCategory} 
                    products={products} 
                    activeFilters={specFilters} 
                    onFilterChange={handleSpecFilterChange} 
                />

                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                  {filteredProducts.length === 0 && (
                      <div className="col-span-full text-center py-10 text-gray-500">Nenhum produto encontrado com estes filtros.</div>
                  )}
                  {filteredProducts.map((product) => (
                    <div key={product.id} onClick={() => setSelectedProduct(product)} className="bg-white rounded-xl shadow-sm border border-gray-100 hover:shadow-lg transition-all cursor-pointer group flex flex-col h-full overflow-hidden">
                      <div className="relative h-48 bg-gray-50">
                        <img src={product.imagens && product.imagens.length > 0 ? product.imagens[0] : 'https://placehold.co/400x300?text=Sem+Imagem'} alt={product.nome} className="w-full h-full object-contain p-2 group-hover:scale-105 transition-transform duration-500" />
                        <span className="absolute top-3 left-3 bg-white/90 text-gray-800 text-xs font-bold px-2 py-1 rounded shadow-sm">{product.categoria}</span>
                      </div>
                      <div className="p-5 flex flex-col flex-1">
                        <h3 className="font-bold text-gray-800 mb-2 line-clamp-2 text-sm">{product.nome}</h3>
                        <p className="text-xs text-gray-500 mb-4 line-clamp-2 flex-1">{product.descricao}</p>
                        <div className="flex justify-between items-center pt-4 border-t border-gray-50 mt-auto">
                          <span className="text-xs text-green-600 font-bold hover:underline uppercase">Ver Detalhes</span>
                          <div className="flex gap-2">
                            <button onClick={(e) => openEditModal(e, product)} className="text-gray-400 hover:text-blue-500 hover:bg-blue-50 p-1.5 rounded-full transition-colors"><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg></button>
                            <button onClick={(e) => handleRemoveProduct(e, product.id, product.categoria)} className="text-gray-400 hover:text-red-500 hover:bg-red-50 p-1.5 rounded-full transition-colors"><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                          </div>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </main>
          <ProductModal product={selectedProduct} onClose={() => setSelectedProduct(null)} />
          <ProductFormModal isOpen={isFormModalOpen} onClose={() => setIsFormModalOpen(false)} onSave={handleSaveProduct} productToEdit={productToEdit} />
          <ImportModal isOpen={isImportModalOpen} onClose={() => setIsImportModalOpen(false)} onImport={handleImportBatch} />
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>

