<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Produtos - bringIT System</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .modal-scroll::-webkit-scrollbar { width: 8px; }
    .modal-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
    .modal-scroll::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
    .modal-scroll::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel" data-presets="typescript,react">
    const { useState, useEffect, useCallback, useMemo } = React;

    // =================================================================================
    // CONFIGURAÇÃO DO SUPABASE
    // =================================================================================
    const SUPABASE_URL = 'https://engvsccurmvttkerpqbs.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVuZ3ZzY2N1cm12dHRrZXJwcWJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4MTA3NjgsImV4cCI6MjA4MDM4Njc2OH0.EzDuXmFcYavKxPD5xBCT46IRaLcxQfnJ9_C9pXxwLhc'; 

    let supabase = null;
    try {
        if (window.supabase) {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            console.log("✅ Supabase iniciado com sucesso!");
        }
    } catch (e) {
        console.error("Erro ao iniciar Supabase:", e);
    }

    // --- CONSTANTES ---
    const Category = {
      SCREEN: 'Tela',
      BATTERY: 'Bateria',
      KEYBOARD: 'Teclado',
      POWER_SUPPLY: 'Fonte'
    };

    // Configuração de quais campos filtrar por categoria
    const FILTERS_CONFIG = {
        [Category.SCREEN]: ['tamanho', 'resolucao', 'iluminacao', 'conector', 'fixacao', 'acabamento'],
        [Category.BATTERY]: ['voltagem', 'capacidade', 'cor', 'tipo'],
        [Category.KEYBOARD]: ['cor', 'idioma', 'moldura', 'backlight', 'marca'],
        [Category.POWER_SUPPLY]: ['voltagem', 'amperagem', 'potencia', 'conector']
    };

    // --- SERVIDOR (SUPABASE) ---
    const Server = {
      login: async (username, password) => {
        // Mock de login para manter a simplicidade solicitada
        return new Promise((resolve) => setTimeout(() => resolve(username === 'Leandro' && password === 'Santos' ? { token: 'supabase-mock-token' } : null), 500));
      },

      isAuthenticated: (token) => !!token,

      getProducts: async () => {
        if (!supabase) return [];
        const { data, error } = await supabase.from('produtos').select('*').order('created_at', { ascending: false });
        if (error) { console.error("Erro Supabase:", error); return []; }
        return data || [];
      },

      addProduct: async (token, product) => {
        if (!supabase) return;
        const { id, ...prodSemId } = product;
        const { data, error } = await supabase.from('produtos').insert([prodSemId]).select();
        if (error) throw error;
        return data[0];
      },

      updateProduct: async (token, product) => {
        if (!supabase) return;
        const { id, ...dadosParaAtualizar } = product;
        const { data, error } = await supabase.from('produtos').update(dadosParaAtualizar).eq('id', id).select();
        if (error) throw error;
        return data[0];
      },

      addBatch: async (token, productsArray) => {
        if (!supabase) return;
        const cleanBatch = productsArray.map(({ id, ...rest }) => rest);
        const { data, error } = await supabase.from('produtos').insert(cleanBatch).select();
        if (error) throw error;
        return data.length;
      },

      removeProduct: async (token, id) => {
        if (!supabase) return;
        const { error } = await supabase.from('produtos').delete().eq('id', id);
        if (error) throw error;
        return true;
      }
    };

    // --- COMPONENTES UI GENÉRICOS ---
    const InputField = ({ label, name, placeholder, required, value, onChange, colSpan = 1 }) => (
      <div className={colSpan > 1 ? `col-span-${colSpan} md:col-span-${colSpan}` : ''}>
        <label className="block text-sm font-semibold text-gray-600 mb-1">{label} {required && <span className="text-red-500">*</span>}</label>
        <input type="text" name={name} value={value || ''} onChange={onChange} placeholder={placeholder} className="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-green-500 focus:border-green-500 placeholder-gray-400 transition-shadow" />
      </div>
    );
    const SelectField = ({ label, name, options, value, onChange }) => (
      <div>
        <label className="block text-sm font-semibold text-gray-600 mb-1">{label}</label>
        <div className="relative">
          <select name={name} value={value || ''} onChange={onChange} className="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-green-500 focus:border-green-500 appearance-none bg-white text-gray-700">
            <option value="">Selecione...</option>{options.map(opt => <option key={opt} value={opt}>{opt}</option>)}
          </select>
          <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500"><svg className="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" /></svg></div>
        </div>
      </div>
    );

    // --- COMPONENTES DE FILTRO ---
    const FilterBar = ({ category, products, activeFilters, onFilterChange }) => {
        if (category === 'Todos') return null;

        // 1. Identificar quais campos devem aparecer para esta categoria
        const fieldsToShow = FILTERS_CONFIG[category] || [];
        if (fieldsToShow.length === 0) return null;

        // 2. Extrair valores únicos existentes nos produtos para criar os <options>
        // Isso faz o filtro ser "inteligente" (só mostra o que tem no banco)
        const filterOptions = useMemo(() => {
            const options = {};
            fieldsToShow.forEach(field => {
                const values = new Set();
                products.forEach(p => {
                    if (p.categoria === category && p.especificacoes && p.especificacoes[field]) {
                        values.add(p.especificacoes[field]);
                    }
                });
                options[field] = Array.from(values).sort();
            });
            return options;
        }, [category, products]);

        return (
            <div className="bg-white border border-gray-200 rounded-lg p-4 mb-6 shadow-sm animate-fade-in">
                <div className="flex items-center gap-2 mb-3 text-gray-700">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" /></svg>
                    <h3 className="text-sm font-bold uppercase">Filtrar {category}</h3>
                </div>
                <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                    {fieldsToShow.map(field => (
                        <div key={field}>
                            <label className="block text-xs font-semibold text-gray-500 mb-1 capitalize">{field.replace('_', ' ')}</label>
                            <select 
                                className="w-full border border-gray-300 rounded text-xs py-1.5 px-2 focus:ring-1 focus:ring-green-500 outline-none bg-gray-50"
                                value={activeFilters[field] || ''}
                                onChange={(e) => onFilterChange(field, e.target.value)}
                            >
                                <option value="">Todos</option>
                                {filterOptions[field] && filterOptions[field].map(val => (
                                    <option key={val} value={val}>{val}</option>
                                ))}
                            </select>
                        </div>
                    ))}
                    {/* Botão para limpar filtros */}
                    {Object.keys(activeFilters).some(k => activeFilters[k]) && (
                        <div className="flex items-end">
                            <button 
                                onClick={() => {
                                    const cleared = {};
                                    fieldsToShow.forEach(f => cleared[f] = '');
                                    // Hacky way to reset, better handled in parent but works here visually
                                    fieldsToShow.forEach(f => onFilterChange(f, ''));
                                }} 
                                className="text-xs text-red-500 hover:text-red-700 underline pb-2"
                            >
                                Limpar
                            </button>
                        </div>
                    )}
                </div>
            </div>
        );
    };

    // --- MODAIS (Mantidos originais com pequenas otimizações) ---
    const ImportModal = ({ isOpen, onClose, onImport }) => {
      if (!isOpen) return null;
      const [jsonText, setJsonText] = useState('');
      const [error, setError] = useState('');
      const handleImport = () => {
        try {
          const parsed = JSON.parse(jsonText);
          if (!Array.isArray(parsed)) throw new Error("O formato deve ser uma lista (Array).");
          onImport(parsed); onClose(); setJsonText(''); setError('');
        } catch (e) { setError("Erro no JSON: " + e.message); }
      };
      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm" onClick={onClose}>
          <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl overflow-hidden flex flex-col" onClick={e => e.stopPropagation()}>
            <div className="bg-indigo-600 px-6 py-4 flex justify-between items-center"><h2 className="text-xl font-bold text-white">Importar em Lote</h2><button onClick={onClose} className="text-white hover:text-indigo-200">✕</button></div>
            <div className="p-6">
              <textarea className="w-full h-64 border border-gray-300 rounded p-3 font-mono text-xs focus:ring-2 focus:ring-indigo-500 outline-none" value={jsonText} onChange={e => setJsonText(e.target.value)} placeholder='[{"nome": "...", ...}]' />
              {error && <p className="text-red-500 text-xs mt-2 font-bold">{error}</p>}
            </div>
            <div className="bg-gray-50 px-6 py-4 flex justify-end gap-3"><button onClick={onClose} className="px-4 py-2 text-gray-600 hover:bg-gray-200 rounded">Cancelar</button><button onClick={handleImport} className="px-4 py-2 bg-indigo-600 text-white font-bold rounded hover:bg-indigo-700">Importar</button></div>
          </div>
        </div>
      );
    };

    const ProductModal = ({ product, onClose }) => {
      if (!product) return null;
      const [activeImage, setActiveImage] = useState(product.imagens ? product.imagens[0] : "");
      useEffect(() => { if(product && product.imagens && product.imagens.length > 0) setActiveImage(product.imagens[0]); }, [product]);

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in" onClick={onClose}>
          <div className="bg-white rounded-lg shadow-2xl w-full max-w-4xl overflow-hidden flex flex-col" onClick={e => e.stopPropagation()}>
            <div className="bg-[#16a34a] px-6 py-4 flex justify-between items-center shrink-0">
              <h2 className="text-xl font-bold text-white">{product.nome}</h2>
              <button onClick={onClose} className="text-white hover:text-green-200">✕</button>
            </div>
            <div className="p-8 overflow-y-auto modal-scroll max-h-[75vh]">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div className="flex flex-col">
                  <div className="w-full h-72 rounded-lg overflow-hidden border border-gray-200 mb-4 bg-gray-50 flex items-center justify-center">
                    {activeImage ? <img src={activeImage} alt={product.nome} className="w-full h-full object-contain" /> : <span className="text-gray-400">Sem imagem</span>}
                  </div>
                  <div className="flex gap-3 mb-6 overflow-x-auto">
                    {product.imagens && product.imagens.map((img, idx) => (
                      <div key={idx} onClick={() => setActiveImage(img)} className={`w-16 h-16 rounded-md overflow-hidden cursor-pointer border-2 transition-all flex-shrink-0 ${activeImage === img ? 'border-green-500 ring-2 ring-green-100' : 'border-gray-200 hover:border-green-300'}`}>
                        <img src={img} className="w-full h-full object-cover" />
                      </div>
                    ))}
                  </div>
                  <div className="mt-auto self-start"><span className="bg-gray-100 text-gray-700 px-4 py-1.5 rounded-full text-sm font-semibold border border-gray-200 shadow-sm">{product.categoria}</span></div>
                </div>
                <div>
                  <h3 className="text-lg font-bold text-gray-900 mb-3">Especificações</h3>
                  <div className="rounded-lg border border-gray-100 overflow-hidden text-sm">
                    {product.especificacoes && Object.entries(product.especificacoes).map(([key, value], index) => (
                      <div key={key} className={`flex justify-between py-3 px-4 ${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'}`}>
                        <span className="font-bold text-gray-600 capitalize">{key.replace(/_/g, ' ')}:</span>
                        <span className="text-gray-800 text-right ml-4">{value}</span>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    const ProductFormModal = ({ isOpen, onClose, onSave, productToEdit }) => {
      if (!isOpen) return null;
      const [tipoProduto, setTipoProduto] = useState('Tela');
      const [form, setForm] = useState({});

      useEffect(() => {
        if (productToEdit) {
          setTipoProduto(productToEdit.categoria);
          setForm({
            nome: productToEdit.nome,
            foto1: productToEdit.imagens ? productToEdit.imagens[0] : '',
            foto2: productToEdit.imagens ? productToEdit.imagens[1] : '',
            ...productToEdit.especificacoes
          });
        } else {
          setTipoProduto('Tela');
          setForm({});
        }
      }, [productToEdit, isOpen]);

      const handleTypeChange = (e) => { setTipoProduto(e.target.value); if (!productToEdit) setForm({}); };
      const handleChange = (e) => { const { name, value } = e.target; setForm(prev => ({ ...prev, [name]: value })); };
      
      const handleSubmit = (e) => {
        e.preventDefault();
        const { nome, foto1, foto2, plug_imagem, ...specs } = form;
        const mainImage = foto1 || plug_imagem || "https://placehold.co/400x300?text=Sem+Imagem";
        const secondaryImage = foto2;
        const imgs = secondaryImage ? [mainImage, secondaryImage] : [mainImage];
        
        const productData = {
          id: productToEdit?.id, 
          nome: nome || `${tipoProduto} ${form.marca || ''} ${form.modelo || ''}`,
          categoria: tipoProduto,
          descricao: `Produto ${form.marca || ''}. SKU: ${form.sku || 'N/A'}`,
          imagens: imgs,
          especificacoes: specs
        };
        onSave(productData);
        onClose();
        setForm({});
      };

      const renderFields = () => {
        switch (tipoProduto) {
          case 'Teclado':
            return (
              <>
                <InputField label="SKU" name="sku" required value={form.sku} onChange={handleChange} />
                <InputField label="Marca" name="marca" required value={form.marca} onChange={handleChange} />
                <InputField label="Modelo" name="modelo" value={form.modelo} onChange={handleChange} />
                <InputField label="Idioma" name="idioma" value={form.idioma} onChange={handleChange} />
                <InputField label="Cor" name="cor" value={form.cor} onChange={handleChange} />
                <SelectField label="Moldura" name="moldura" options={['Com Moldura', 'Sem Moldura']} value={form.moldura} onChange={handleChange} />
                <SelectField label="Backlight" name="backlight" options={['Sim', 'Não']} value={form.backlight} onChange={handleChange} />
                <InputField label="Foto URL" name="foto1" value={form.foto1} onChange={handleChange} />
              </>
            );
          case 'Bateria':
            return (
              <>
                <InputField label="SKU" name="sku" required value={form.sku} onChange={handleChange} />
                <InputField label="Marca" name="marca" required value={form.marca} onChange={handleChange} />
                <InputField label="Voltagem (V)" name="voltagem" value={form.voltagem} onChange={handleChange} />
                <InputField label="Capacidade (mAh)" name="capacidade" value={form.capacidade} onChange={handleChange} />
                <InputField label="Cor" name="cor" value={form.cor} onChange={handleChange} />
                <InputField label="Tipo" name="tipo" value={form.tipo} onChange={handleChange} />
                <InputField label="Foto URL" name="foto1" value={form.foto1} onChange={handleChange} />
              </>
            );
          case 'Fonte':
            return (
              <>
                <InputField label="SKU" name="sku" required value={form.sku} onChange={handleChange} />
                <InputField label="Voltagem (V)" name="voltagem" value={form.voltagem} onChange={handleChange} />
                <InputField label="Amperagem (A)" name="amperagem" value={form.amperagem} onChange={handleChange} />
                <InputField label="Potência (W)" name="potencia" value={form.potencia} onChange={handleChange} />
                <InputField label="Conector" name="conector" value={form.conector} onChange={handleChange} />
                <InputField label="Foto URL" name="foto1" value={form.foto1} onChange={handleChange} />
              </>
            );
          default: // Tela
            return (
              <>
                <InputField label="SKU" name="sku" required value={form.sku} onChange={handleChange} />
                <InputField label="Marca" name="marca" required value={form.marca} onChange={handleChange} />
                <InputField label="Tamanho" name="tamanho" value={form.tamanho} onChange={handleChange} />
                <InputField label="Resolução" name="resolucao" value={form.resolucao} onChange={handleChange} />
                <SelectField label="Iluminação" name="iluminacao" options={['LED', 'CCFL', 'OLED']} value={form.iluminacao} onChange={handleChange} />
                <InputField label="Conector" name="conector" value={form.conector} onChange={handleChange} />
                <SelectField label="Fixação" name="fixacao" options={['Abas', 'Sem Fixação']} value={form.fixacao} onChange={handleChange} />
                <SelectField label="Acabamento" name="acabamento" options={['Brilhante', 'Fosco']} value={form.acabamento} onChange={handleChange} />
                <InputField label="Foto URL" name="foto1" value={form.foto1} onChange={handleChange} />
              </>
            );
        }
      };

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm" onClick={onClose}>
          <div className="bg-white rounded-lg shadow-xl w-full max-w-4xl overflow-hidden flex flex-col max-h-[90vh]" onClick={e => e.stopPropagation()}>
            <div className="bg-[#16a34a] px-6 py-4 flex justify-between items-center shrink-0">
               <h2 className="text-xl font-bold text-white">{productToEdit ? 'Editar' : 'Novo'} {tipoProduto}</h2>
               <button onClick={onClose} className="text-white hover:text-green-200">✕</button>
            </div>
            <div className="p-6 overflow-y-auto modal-scroll bg-white">
              <div className="border border-gray-200 rounded-lg p-5 mb-8 bg-white shadow-sm">
                <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Categoria</label>
                <select className="w-full border p-2 rounded" value={tipoProduto} onChange={handleTypeChange} disabled={!!productToEdit}>
                  {Object.values(Category).map(c => <option key={c} value={c}>{c}</option>)}
                </select>
                <div className="mt-4">
                    <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Nome Personalizado (Opcional)</label>
                    <input name="nome" value={form.nome || ''} onChange={handleChange} className="w-full border p-2 rounded" placeholder="Preencha se quiser sobrescrever o nome automático" />
                </div>
              </div>
              <form onSubmit={handleSubmit}><div className="grid grid-cols-1 md:grid-cols-3 gap-4">{renderFields()}</div></form>
            </div>
            <div className="border-t border-gray-100 p-6 bg-white shrink-0 flex justify-end gap-3">
               <button onClick={onClose} className="px-6 py-2 border rounded">Cancelar</button>
               <button onClick={handleSubmit} className="px-6 py-2 bg-[#16a34a] text-white rounded font-bold">Salvar</button>
            </div>
          </div>
        </div>
      );
    };

    // --- APP PRINCIPAL ---
    const App = () => {
      const [token, setToken] = useState(localStorage.getItem('authToken'));
      const [products, setProducts] = useState([]);
      const [filteredProducts, setFilteredProducts] = useState([]);
      const [currentView, setCurrentView] = useState('dashboard');
      const [selectedCategory, setSelectedCategory] = useState('Todos');
      const [isProductsSubmenuOpen, setIsProductsSubmenuOpen] = useState(true);
      const [searchQuery, setSearchQuery] = useState('');
      
      // Estado para filtros específicos
      const [specFilters, setSpecFilters] = useState({});

      const [selectedProduct, setSelectedProduct] = useState(null);
      const [isFormModalOpen, setIsFormModalOpen] = useState(false);
      const [productToEdit, setProductToEdit] = useState(null);
      const [isImportModalOpen, setIsImportModalOpen] = useState(false);

      const fetchProducts = useCallback(async () => {
        try { const data = await Server.getProducts(); setProducts(data); } catch (e) { console.error(e); }
      }, []);

      useEffect(() => { if (token) fetchProducts(); }, [token, fetchProducts]);

      // Função para resetar filtros ao trocar categoria
      const handleCategoryChange = (cat) => {
          setSelectedCategory(cat);
          setSpecFilters({}); // Reseta filtros específicos
          setCurrentView('products');
      };

      const handleSpecFilterChange = (field, value) => {
          setSpecFilters(prev => ({ ...prev, [field]: value }));
      };

      // EFEITO DE FILTRAGEM UNIFICADO
      useEffect(() => {
        let result = products;

        // 1. Filtro por Categoria
        if (selectedCategory !== 'Todos') {
          result = result.filter(p => p.categoria === selectedCategory);
        }

        // 2. Filtro por Especificações (Filtros de Select)
        if (selectedCategory !== 'Todos') {
             Object.entries(specFilters).forEach(([key, value]) => {
                 if (value && value !== '') {
                     result = result.filter(p => 
                         p.especificacoes && 
                         p.especificacoes[key] && 
                         String(p.especificacoes[key]).toLowerCase() === value.toLowerCase()
                     );
                 }
             });
        }

        // 3. Filtro por Texto (Busca geral)
        if (searchQuery) {
          const lowerQuery = searchQuery.toLowerCase();
          result = result.filter(p => {
            const nome = p.nome ? p.nome.toLowerCase() : '';
            const desc = p.descricao ? p.descricao.toLowerCase() : '';
            const sku = p.especificacoes?.sku ? String(p.especificacoes.sku).toLowerCase() : '';
            
            if (nome.includes(lowerQuery) || desc.includes(lowerQuery) || sku.includes(lowerQuery)) return true;
            
            // Busca profunda nas especificações
            if (p.especificacoes) {
              return Object.values(p.especificacoes).some(val => val && String(val).toLowerCase().includes(lowerQuery));
            }
            return false;
          });
        }

        setFilteredProducts(result);
      }, [products, selectedCategory, searchQuery, specFilters]);

      const logout = () => { localStorage.removeItem('authToken'); setToken(null); };

      const handleSaveProduct = async (productData) => {
        if (!token) return;
        try { 
          if (productData.id) await Server.updateProduct(token, productData);
          else await Server.addProduct(token, productData); 
          fetchProducts(); 
          setCurrentView('products'); 
        } catch (e) { alert("Erro: " + e.message); }
      };

      const handleImportBatch = async (batchData) => {
        if (!token) return;
        try { 
          const count = await Server.addBatch(token, batchData); 
          alert(`${count} importados!`);
          fetchProducts(); 
        } catch (e) { alert("Erro: " + e.message); }
      };

      const handleRemoveProduct = async (e, id) => {
        e.stopPropagation();
        if (confirm("Remover?")) { 
            try { await Server.removeProduct(token, id); fetchProducts(); }
            catch(e) { alert("Erro: " + e.message); }
        }
      };

      const openEditModal = (e, product) => { e.stopPropagation(); setProductToEdit(product); setIsFormModalOpen(true); };
      const openNewModal = () => { setProductToEdit(null); setIsFormModalOpen(true); };

      const LoginScreen = ({ onLogin }) => {
        const [u, setU] = useState('Leandro'); const [p, setP] = useState('Santos'); const [load, setLoad] = useState(false);
        const sub = async (e) => { e.preventDefault(); setLoad(true); const r = await Server.login(u, p); setLoad(false); if(r) { localStorage.setItem('authToken', r.token); onLogin(); } else alert('Use: Leandro / Santos'); };
        return (
          <div className="min-h-screen flex items-center justify-center bg-gray-100"><div className="bg-white p-8 rounded-xl shadow-lg w-96">
            <h1 className="text-2xl font-bold text-center text-green-700 mb-6">bringIT Admin</h1>
            <form onSubmit={sub} className="space-y-4">
              <input value={u} onChange={e=>setU(e.target.value)} className="w-full border p-2 rounded" placeholder="Usuário" />
              <input type="password" value={p} onChange={e=>setP(e.target.value)} className="w-full border p-2 rounded" placeholder="Senha" />
              <button disabled={load} className="w-full bg-green-600 text-white p-2 rounded hover:bg-green-700">{load?'...':'Entrar'}</button>
            </form>
          </div></div>
        );
      };

      const Dashboard = ({ products }) => {
        const cats = products.reduce((acc, p) => { acc[p.categoria] = (acc[p.categoria]||0)+1; return acc; }, {});
        return (
          <div className="animate-fade-in">
            <h2 className="text-2xl font-bold text-gray-800 mb-6">Visão Geral</h2>
            <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
              <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200"><p className="text-gray-500 text-sm font-bold uppercase">Total</p><p className="text-3xl font-bold text-gray-900 mt-2">{products.length}</p></div>
              {Object.keys(cats).map(c => (
                <div key={c} className="bg-white p-6 rounded-xl shadow-sm border border-gray-200"><p className="text-gray-500 text-sm font-bold uppercase truncate">{c}</p><p className="text-3xl font-bold text-gray-900 mt-2">{cats[c]}</p></div>
              ))}
            </div>
          </div>
        );
      };

      if (!token) return <LoginScreen onLogin={() => setToken(localStorage.getItem('authToken'))} />;

      return (
        <div className="flex min-h-screen bg-gray-50 font-inter">
          <aside className="w-66 bg-white fixed h-full shadow-lg z-20 flex flex-col hidden md:flex ">
            <div className="p-6 border-b border-gray-100">
            <div className="flex items-center gap-2 text-green-700 " >
            <div className=" text-2xl text-green-700 p-1.5 rounded-lg font-bold">bringIT</div>
            <h1 className="text-xs">CustomerSuccess</h1>
            </div></div>
            <nav className="flex-1 py-6 overflow-y-auto ">
              <ul>
                <li className={`flex items-center gap-3 px-4 py-3 cursor-pointer transition-all duration-200 border-r-4 ${currentView === 'dashboard' ? 'bg-green-50 text-green-700 border-green-600 font-medium' : 'text-gray-600  border-transparent hover:bg-gray-50'}`} onClick={() => setCurrentView('dashboard')}>
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2z" /></svg><span>Dashboard</span>
                </li>
                <li>
                  <div className="flex items-center justify-between px-4 py-3 cursor-pointer text-gray-600 hover:text-gray-900" onClick={() => setIsProductsSubmenuOpen(!isProductsSubmenuOpen)}>
                    <div className="flex items-center gap-3"><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg><span>Produtos</span></div>
                    <svg className={`w-4 h-4 transition-transform ${isProductsSubmenuOpen ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" /></svg>
                  </div>
                  {isProductsSubmenuOpen && (
                    <ul className="bg-gray-50/50 py-2 space-y-1">
                      <li className={`flex items-center gap-3 px-4 py-2 text-sm cursor-pointer border-r-4 pl-12 ${currentView === 'products' && selectedCategory === 'Todos' ? 'bg-green-50 text-green-700 border-green-600 font-medium' : 'text-gray-600 border-transparent hover:bg-gray-50'}`} onClick={() => handleCategoryChange('Todos')}>Todos</li>
                      {Object.values(Category).map(cat => (
                         <li key={cat} className={`flex items-center gap-3 px-4 py-2 text-sm cursor-pointer border-r-4 pl-12 ${currentView === 'products' && selectedCategory === cat ? 'bg-green-50 text-green-700 border-green-600 font-medium' : 'text-gray-600 border-transparent hover:bg-gray-50'}`} onClick={() => handleCategoryChange(cat)}>{cat}</li>
                      ))}
                    </ul>
                  )}
                </li>
              </ul>
            </nav>
          </aside>

          <main className="flex-1 ml-0 md:ml-64 p-6 md:p-8 transition-all">
             <div className="md:hidden mb-4 flex justify-between items-center bg-white p-4 rounded-lg shadow-sm"><span className="font-bold text-green-600">bringIT</span><button onClick={logout} className="text-sm text-red-500">Sair</button></div>

            {currentView === 'dashboard' && <Dashboard products={products} />}
            {currentView === 'products' && (
              <div className="animate-fade-in">
                 <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                   <div><h2 className="text-2xl font-bold text-gray-800">{selectedCategory === 'Todos' ? 'Catálogo' : selectedCategory}</h2><p className="text-gray-500 text-sm mt-1">Gerencie seu estoque.</p></div>
                   <div className="flex gap-2">
                     <button onClick={() => setIsImportModalOpen(true)} className="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 shadow-sm flex items-center gap-2 font-bold text-sm">Importar Lote</button>
                     <button onClick={openNewModal} className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 shadow-sm flex items-center gap-2 font-bold text-sm">+ Novo</button>
                   </div>
                 </div>
                
                {/* BARRA DE BUSCA GLOBAL */}
                <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-6 relative">
                   <input type="text" placeholder="Buscar por Nome, SKU ou Descrição..." className="w-full border border-gray-200 bg-gray-50 rounded-lg pl-10 pr-10 py-3 focus:bg-white focus:ring-2 focus:ring-green-100 outline-none" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} />
                   <svg className="absolute left-7 top-7 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                   {searchQuery && <button onClick={() => setSearchQuery('')} className="absolute right-7 top-7 text-gray-400">&times;</button>}
                </div>

                {/* FILTROS ESPECÍFICOS POR CATEGORIA */}
                <FilterBar 
                    category={selectedCategory} 
                    products={products} 
                    activeFilters={specFilters} 
                    onFilterChange={handleSpecFilterChange} 
                />

                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                  {filteredProducts.length === 0 && (
                      <div className="col-span-full text-center py-10 text-gray-500">Nenhum produto encontrado com estes filtros.</div>
                  )}
                  {filteredProducts.map((product) => (
                    <div key={product.id} onClick={() => setSelectedProduct(product)} className="bg-white rounded-xl shadow-sm border border-gray-100 hover:shadow-lg transition-all cursor-pointer group flex flex-col h-full overflow-hidden">
                      <div className="relative h-48 bg-gray-50">
                        <img src={product.imagens && product.imagens.length > 0 ? product.imagens[0] : 'https://placehold.co/400x300?text=Sem+Imagem'} alt={product.nome} className="w-full h-full object-contain p-2 group-hover:scale-105 transition-transform duration-500" />
                        <span className="absolute top-3 left-3 bg-white/90 text-gray-800 text-xs font-bold px-2 py-1 rounded shadow-sm">{product.categoria}</span>
                      </div>
                      <div className="p-5 flex flex-col flex-1">
                        <h3 className="font-bold text-gray-800 mb-2 line-clamp-2 text-sm">{product.nome}</h3>
                        <p className="text-xs text-gray-500 mb-4 line-clamp-2 flex-1">{product.descricao}</p>
                        <div className="flex justify-between items-center pt-4 border-t border-gray-50 mt-auto">
                          <span className="text-xs text-green-600 font-bold hover:underline uppercase">Ver Detalhes</span>
                          <div className="flex gap-2">
                            <button onClick={(e) => openEditModal(e, product)} className="text-gray-400 hover:text-blue-500 hover:bg-blue-50 p-1.5 rounded-full transition-colors"><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg></button>
                            <button onClick={(e) => handleRemoveProduct(e, product.id)} className="text-gray-400 hover:text-red-500 hover:bg-red-50 p-1.5 rounded-full transition-colors"><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                          </div>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </main>
          <ProductModal product={selectedProduct} onClose={() => setSelectedProduct(null)} />
          <ProductFormModal isOpen={isFormModalOpen} onClose={() => setIsFormModalOpen(false)} onSave={handleSaveProduct} productToEdit={productToEdit} />
          <ImportModal isOpen={isImportModalOpen} onClose={() => setIsImportModalOpen(false)} onImport={handleImportBatch} />
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
